System.register(["jimu-core"],(function(e,t){var r={};return{setters:[function(e){r.AppMode=e.AppMode,r.CONSTANTS=e.CONSTANTS,r.DataSourceManager=e.DataSourceManager,r.Immutable=e.Immutable,r.JimuFieldType=e.JimuFieldType,r.ServiceManager=e.ServiceManager,r.SessionManager=e.SessionManager,r.appActions=e.appActions,r.dataSourceUtils=e.dataSourceUtils,r.dateUtils=e.dateUtils,r.esri=e.esri,r.getAppStore=e.getAppStore,r.jimuHistory=e.jimuHistory,r.loadArcGISJSAPIModules=e.loadArcGISJSAPIModules,r.lodash=e.lodash,r.observeStore=e.observeStore,r.portalUrlUtils=e.portalUrlUtils,r.requestUtils=e.requestUtils,r.utils=e.utils,r.uuidv1=e.uuidv1}],execute:function(){e((()=>{"use strict";var e={1810:e=>{e.exports=r}},t={};function i(r){var a=t[r];if(void 0!==a)return a.exports;var o=t[r]={exports:{}};return e[r](o,o.exports,i),o.exports}i.d=(e,t)=>{for(var r in t)i.o(t,r)&&!i.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var a={};return(()=>{var e,t,r,o,s,n,d;i.r(a),i.d(a,{AbstractDataRecord:()=>A,AbstractDataSource:()=>h,AbstractLayerFolderDataSource:()=>y,AbstractLoadableDataSource:()=>v,AbstractQueriableDataSource:()=>R,AbstractSetDataSource:()=>S,CsvDataSourceImpl:()=>V,DataSourceError:()=>u,DataSourceStatus:()=>e,DataSourceTypes:()=>t,FeatureDataRecordImpl:()=>b,FeatureLayerDataSourceImpl:()=>E,FeatureServiceDataSourceImpl:()=>O,GroupLayerDataSourceImpl:()=>U,JimuCoreDataSourceFactory:()=>W,MapServiceDataSourceImpl:()=>M,QueryScope:()=>d,SceneLayerDataSourceImpl:()=>q,SceneServiceDataSourceImpl:()=>N,SimpleDataRecordImpl:()=>P,SimpleDataRecordSetImpl:()=>C,SimpleLocalDataSourceImpl:()=>x,SupportedItemTypes:()=>s,SupportedLayerServiceTypes:()=>r,SupportedLayerTypes:()=>n,SupportedServiceTypes:()=>o,default:()=>G}),function(e){e.NotCreated="NOT_CREATED",e.Created="CREATED",e.CreateError="CREATE_ERROR",e.NotReady="NOT_READY",e.Unloaded="UNLOADED",e.Loading="LOADING",e.Loaded="LOADED",e.LoadError="LOAD_ERROR",e.Saving="SAVING",e.Saved="SAVED",e.SaveError="SAVE_ERROR",e.Closed="CLOSED",e.Connecting="CONNECTING",e.Connected="CONNECTED",e.Closing="CLOSING"}(e||(e={})),function(e){e.SimpleLocal="SIMPLE_LOCAL",e.CSV="CSV",e.FeatureLayer="FEATURE_LAYER",e.SceneLayer="SCENE_LAYER",e.GroupLayer="GROUP_LAYER",e.FeatureService="FEATURE_SERVICE",e.MapService="MAP_SERVICE",e.SceneService="SCENE_SERVICE"}(t||(t={})),function(e){e.FeatureLayer="Feature Layer",e.Table="Table",e.GroupLayer="Group Layer",e.SceneLayerPoint="Point",e.SceneLayer3DObject="3DObject"}(r||(r={})),function(e){e.FeatureService="FeatureServer",e.MapService="MapServer",e.SceneService="SceneServer"}(o||(o={})),function(e){e.WebMap="Web Map",e.WebScene="Web Scene",e.FeatureService="Feature Service",e.MapService="Map Service",e.SceneService="Scene Service",e.FeatureCollection="Feature Collection"}(s||(s={})),function(e){e.FeatureLayer="feature",e.MapImageLayer="map-image",e.TileLayer="tile",e.GroupLayer="group",e.SceneLayer="scene"}(n||(n={})),function(e){e.InAllData="IN_ALL_DATA",e.InRemoteConfigView="IN_REMOTE_CONFIG_VIEW",e.InConfigView="IN_CONFIG_VIEW",e.InRuntimeView="IN_RUNTIME_VIEW"}(d||(d={}));class u extends Error{constructor(e,t){super(t),this.dataSourceId=e}}var c=i(1810),l=function(e,t,r,i){return new(r||(r=Promise))((function(a,o){function s(e){try{d(i.next(e))}catch(e){o(e)}}function n(e){try{d(i.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,n)}d((i=i.apply(e,t||[])).next())}))};class h{constructor(e){if(this.isDataSourceSet=!1,this.records=[],Object.assign(this,e),this.originDataSourceJson=e.dataSourceJson,e.dataSourceJson)this.isDataView=!1,this.isLocal=!1,e.dataSourceJson.url&&(this.url=e.dataSourceJson.url);else{if(!e.belongToDataSource)return void console.error("bad DataSourceConstructorOptions.");e.localId?(this.isLocal=!0,this.isDataView=!1):(this.isLocal=!1,this.isDataView=!0)}this.getDataSourceJson().isDataInDataSourceInstance&&(this.sourceRecords=e.sourceRecords,this.url=null),this.isLocal?this.listenSelection=!1:this.listenSelection=!0}get url(){return c.dataSourceUtils.getWhetherUseProxy()&&c.dataSourceUtils.getDataSourceProxyUrl(this._url)||this._url}set url(e){this._url=e}getLabel(){const e=this.getDataSourceJson().label||this.getSchema().label;if(this.isLocal)return this.belongToDataSource.getLabel();if(this.isDataView){const t=this.getMainDataSource().getDataSourceJson(),r=(null==t?void 0:t.dataViews)&&t.dataViews[this.dataViewId];return(null==r?void 0:r.label)||e}return e}getDataSourceJson(){if(this.isDataView||this.isLocal){let e=this.getMainDataSource().getDataSourceJson();return this.dataViewId===c.CONSTANTS.SELECTION_DATA_VIEW_ID&&(e=e.set("isDataInDataSourceInstance",!0)),e}return this.dataSourceJson}setDataSourceJson(e){e?this.dataSourceJson?this.dataSourceJson=this.traverseToMergeDataSourceJson(this.dataSourceJson,e):this.dataSourceJson=e:this.dataSourceJson=this.originDataSourceJson}traverseToMergeDataSourceJson(e,t){if(!e&&!t)return console.error("Can not merge data source json since do not have base data source json or new data source json."),(0,c.Immutable)({});if(!e)return t;if(!t)return e;let r=e.merge(t.asMutable({deep:!0}));return["label","isHidden","useFields","query","dataViews","childDataSourceJsons","schema","url","itemId","portalUrl"].forEach((i=>{t[i]||(r=r.without(i)),t[i]&&"schema"===i&&(r=r.set("schema",t.schema)),!t[i]||"url"!==i&&"portalUrl"!==i&&"itemId"!==i||(r=r.set(i,t[i]),this[i]=t[i],this.canSaveSource()&&this.getAllDerivedDataSources().forEach((e=>{e[i]=t[i]}))),e[i]&&"useFields"===i&&(r=t.schema?r.set("useFields",e.useFields.filter((e=>{var r;return!!(null===(r=t.schema.fields)||void 0===r?void 0:r[e])}))):r.set("useFields",e.useFields))})),r.childDataSourceJsons&&Object.keys(r.childDataSourceJsons).forEach((i=>{var a;const o=this.traverseToMergeDataSourceJson(null===(a=null==e?void 0:e.childDataSourceJsons)||void 0===a?void 0:a[i],t.childDataSourceJsons[i]);r=r.setIn(["childDataSourceJsons",i],o)})),r}getSchema(){return this.isDataView||this.isLocal?this.getMainDataSource().getSchema():this.schema||{}}getSelectedFields(){var e,t,r,i;let a;if(this.isLocal)return this.belongToDataSource.getSelectedFields();const o=(null===(e=this.getSchema())||void 0===e?void 0:e.fields)?Object.keys(this.getSchema().fields):[];if(a=this.isDataView?null===(r=null===(t=this.getDataSourceJson().dataViews)||void 0===t?void 0:t[this.dataViewId])||void 0===r?void 0:r.outFields:null===(i=this.getDataSourceJson().query)||void 0===i?void 0:i.outFields,!a&&!this.selectedFields)return o;let s=o;return a&&(s=s.filter((e=>a.includes(e)))),this.selectedFields&&(s=s.filter((e=>this.selectedFields.includes(e)))),s}setSelectedFields(e){this.selectedFields=e}setSchema(e){this.schema=e}fetchSchema(){return l(this,void 0,void 0,(function*(){return yield Promise.resolve((0,c.Immutable)({}))}))}getFetchedSchema(){return this.isDataView||this.isLocal?this.getMainDataSource().getFetchedSchema():this.fetchedSchema}setFetchedSchema(e){this.fetchedSchema=e}getGeometryType(){return null}getReversedConfigSchema(){if(this.isDataView||this.isLocal)return this.getMainDataSource().getReversedConfigSchema();if(this.reverseSchema)return this.reverseSchema;if(this.isDataSourceSet){const e=this.getDataSourceJson().schema,t={childSchemas:{}};if(!e)return(0,c.Immutable)({});if(!e.childSchemas)return(0,c.Immutable)({label:e.label,childId:e.childId,jimuChildId:e.jimuChildId});Object.keys(e.childSchemas).forEach((r=>{const i=e.childSchemas[r].childId;t.childSchemas[i]?t.childSchemas[i].push(this.getOneReversedConfigSchema(e.childSchemas[r])):t.childSchemas[i]=[this.getOneReversedConfigSchema(e.childSchemas[r])]})),this.reverseSchema=(0,c.Immutable)(t)}else this.reverseSchema=this.getOneReversedConfigSchema(this.getDataSourceJson().schema);return this.reverseSchema}setRecords(e){this.records=e,this.addVersion()}setJsonData(e){console.error("please implement this. setJsonData")}getOneReversedConfigSchema(e){const t={};return e?(t.fields={},Object.keys(e.fields).forEach((r=>{const i=e.fields[r].asMutable({deep:!0});t.fields[i.name]?t.fields[i.name].push(i):t.fields[i.name]=[i]})),e.childId&&(t.childId=e.childId),e.jimuChildId&&(t.jimuChildId=e.jimuChildId),(0,c.Immutable)(t)):(0,c.Immutable)(t)}getStatus(){return(0,c.getAppStore)().getState().dataSourcesInfo[this.id]&&(0,c.getAppStore)().getState().dataSourcesInfo[this.id].status}setStatus(e){(0,c.getAppStore)().dispatch(c.appActions.dataSourceStatusChanged(this.id,e))}getCountStatus(){return(0,c.getAppStore)().getState().dataSourcesInfo[this.id]&&(0,c.getAppStore)().getState().dataSourcesInfo[this.id].countStatus}setCountStatus(e){(0,c.getAppStore)().dispatch(c.appActions.dataSourceCountStatusChanged(this.id,e))}getVersion(){var e;return null===(e=(0,c.getAppStore)().getState().dataSourcesInfo[this.id])||void 0===e?void 0:e.version}addVersion(){(0,c.getAppStore)().dispatch(c.appActions.dataSourceVersionAdded(this.id))}getSourceVersion(){var e;return this.canSaveSource()?null===(e=(0,c.getAppStore)().getState().dataSourcesInfo[this.id])||void 0===e?void 0:e.sourceVersion:this.getMainDataSource().getSourceVersion()}addSourceVersion(){this.canSaveSource()&&(0,c.getAppStore)().dispatch(c.appActions.dataSourceSourceVersionAdded(this.id))}getSelectedRecordIdsFromInfo(){var e,t;return(null===(t=null===(e=(0,c.getAppStore)().getState().dataSourcesInfo)||void 0===e?void 0:e[this.id])||void 0===t?void 0:t.selectedIds)||(0,c.Immutable)([])}setSelectedRecordIdsToInfo(e,t){e&&(this.getListenSelection()||this.id===(null==t?void 0:t.id))&&(0,c.getAppStore)().dispatch(c.appActions.dataSourceSelectedIdsChanged(this.id,e))}getRecords(){return this.records}getRecordsWithSelection(){return this.concatRecordsAndSelection(this.getRecords(),this.getSelectedRecords())}concatRecordsAndSelection(e,t){let r=e||[];return null==t||t.forEach((t=>{(null==e?void 0:e.some((e=>(null==e?void 0:e.getId())===(null==t?void 0:t.getId()))))||(r=r.concat(t))})),r}clearSourceRecordsNotAddVersion(){this.clearRecordsNotAddVersion(),this.sourceRecords=[]}clearSourceRecords(){this.clearSourceRecordsNotAddVersion(),this.addSourceVersion(),this.addVersion()}setSourceRecords(e){this.canSaveSource()&&(this.clearRecordsNotAddVersion(),c.lodash.defer((()=>{this.setSelectedRecordIdsToInfo([],this.getMainDataSource())})),this.sourceRecords=e.filter((e=>!!e)).map((e=>(e.dataSource=this,e))),this.getAllDerivedDataSources().forEach((e=>{e.clearRecords(),c.lodash.defer((()=>{e.setSelectedRecordIdsToInfo([],e.getMainDataSource())}))})),this.addSourceVersion(),this.addVersion())}getSourceRecords(){var e;if(!this.canSaveSource())return this.isLocalViewOfSelectionView()?this.belongToDataSource.getSourceRecords():this.getMainDataSource().getSourceRecords();let t=this.sourceRecords||[];if(this.useNoSelectionView()){const r=this.getMainDataSource().getDataView(c.CONSTANTS.DATA_VIEW_ID_FOR_NO_SELECTION);r&&(t=null===(e=r.getRecords())||void 0===e?void 0:e.map((e=>(e.dataSource=this,e))))}return t}useNoSelectionView(){const e=this.sourceRecords||[];return this.isSelectionView()&&0===e.length}canSaveSource(){return!this.isDataView&&!this.isLocal||this.isSelectionView()}getSelectionDataView(){const e=this.isDataView||this.isLocal?this.getMainDataSource().id:this.id;return this.dataSourceManager.getDataViewDataSource(e,c.CONSTANTS.SELECTION_DATA_VIEW_ID)}getSelectedRecords(){const e=this.getSelectionDataView(),t=e?e.getRecords():[],r=this.getSelectedRecordIds();return t.filter((e=>r.includes(e.getId())))}getSelectedRecordIndexes(){if(!(0,c.getAppStore)().getState().dataSourcesInfo[this.id])return[];const e=this.isDataView||this.isLocal?this.getMainDataSource().id:this.id;return(0,c.getAppStore)().getState().dataSourcesInfo[e].selectedIndexes?(0,c.getAppStore)().getState().dataSourcesInfo[e].selectedIndexes.asMutable():(0,c.getAppStore)().getState().dataSourcesInfo[e].selectedIds?(0,c.getAppStore)().getState().dataSourcesInfo[e].selectedIds.asMutable().map((e=>this.getRecords().findIndex((t=>t.getId()===e)))):[]}getSelectedRecordIds(){return this.isSelectionView()?this.getMainDataSource().getSelectedRecordIdsFromInfo().asMutable():this.getSelectedRecordIdsFromInfo().asMutable()}nextRecord(){if(this.getSelectedRecordIndexes().length>1)return console.warn('method "nextRecord" only works when single record is selected'),null;if(this.getSelectedRecordIndexes().indexOf(this.getRecords().length-1))throw Error("Reach the end of data.");return(0,c.getAppStore)().dispatch(c.appActions.dataSourceSelectedIndexesChanged(this.id,[this.getSelectedRecordIndexes()[0]++])),this.getSelectedRecords()[0]}prevRecord(){if(this.getSelectedRecordIndexes().length>1)return console.warn('method "prevRecord" only works when single record is selected'),null;if(this.getSelectedRecordIndexes().indexOf(0))throw Error("Reach the start of data.");return(0,c.getAppStore)().dispatch(c.appActions.dataSourceSelectedIndexesChanged(this.id,[this.getSelectedRecordIndexes()[0]--])),this.getSelectedRecords()[0]}getRecord(e){return this.getRecords()[e]}getSourceRecord(e){return this.getSourceRecords()[e]}getRecordById(e){return this.getRecords().filter((t=>t&&t.getId()===e))[0]}getSourceRecordById(e){return this.getSourceRecords().filter((t=>t&&t.getId()===e))[0]}clearSelection(){this.clearOneDsSelection(this.getMainDataSource()),this.getMainDataSource().getAllDerivedDataSources().forEach((e=>this.clearOneDsSelection(e)))}clearOneDsSelection(e){(0,c.getAppStore)().dispatch(c.appActions.dataSourceSelectedIndexesChanged(e.id,null)),(0,c.getAppStore)().dispatch(c.appActions.dataSourceSelectedIdsChanged(e.id,null)),e===this.getMainDataSource()&&(c.jimuHistory.changeQueryObjectByDataRecordIds(e.id,null),c.jimuHistory.changeQueryObjectByDataRecordIndexes(e.id,null),this.copySelectionToDataView([]))}updateSelectionStateAndChangeUrl(e,t){const r=this.getMainDataSource();if("byIndex"===e){const e=this.getDataSourceJson().isDataInDataSourceInstance?this.getSourceRecords():this.getRecords(),i=t.map((t=>{var r;return null===(r=e[t])||void 0===r?void 0:r.getId()}));(0,c.getAppStore)().dispatch(c.appActions.dataSourceSelectedIndexesChanged(this.id,t)),r.getAllDerivedDataSources().forEach((e=>{e.id!==this.dataSourceManager.getDataViewDataSourceId(r.id,c.CONSTANTS.SELECTION_DATA_VIEW_ID)&&e.id!==this.dataSourceManager.getDataViewDataSourceId(r.id,c.CONSTANTS.DATA_VIEW_ID_FOR_NO_SELECTION)&&e.id!==this.id&&(0,c.getAppStore)().dispatch(c.appActions.dataSourceSelectedIdsChanged(e.id,i))})),this===r?c.jimuHistory.changeQueryObjectByDataRecordIndexes(this.id,t):((0,c.getAppStore)().dispatch(c.appActions.dataSourceSelectedIdsChanged(r.id,i)),c.jimuHistory.changeQueryObjectByDataRecordIds(r.id,i))}else"byId"===e&&(r.getAllDerivedDataSources().forEach((e=>{e.id!==this.dataSourceManager.getDataViewDataSourceId(r.id,c.CONSTANTS.SELECTION_DATA_VIEW_ID)&&e.id!==this.dataSourceManager.getDataViewDataSourceId(r.id,c.CONSTANTS.DATA_VIEW_ID_FOR_NO_SELECTION)&&e.setSelectedRecordIdsToInfo(t,this)})),r.setSelectedRecordIdsToInfo(t,this),c.jimuHistory.changeQueryObjectByDataRecordIds(r.id,t))}selectRecord(e){const t=this.getDataSourceJson().isDataInDataSourceInstance?this.getSourceRecord(e):this.getRecord(e);this.copySelectionToDataView([t]),this.updateSelectionStateAndChangeUrl("byIndex",[e])}selectRecords(e){const t=this.getDataSourceJson().isDataInDataSourceInstance?this.getSourceRecords():this.getRecords(),r=e.map((e=>t[e]));this.copySelectionToDataView(r),this.updateSelectionStateAndChangeUrl("byIndex",e)}selectRecordById(e,t){if(this.getSelectedRecordIds().find((t=>t===e)))return;let r;r=this.getDataSourceJson().isDataInDataSourceInstance?t||e&&this.getSourceRecordById(e):t||e&&this.getRecordById(e),this.copySelectionToDataView([r]),this.updateSelectionStateAndChangeUrl("byId",[e])}selectRecordsByIds(e,t){const r=this.getDataSourceJson().isDataInDataSourceInstance?this.getSourceRecords():this.getRecords(),i=t||e.map((e=>r.find((t=>(null==t?void 0:t.getId())===e))));this.copySelectionToDataView(i),this.updateSelectionStateAndChangeUrl("byId",e)}copySelectionToDataView(e){const t=this.getSelectionDataView();t&&(t.setSourceRecords(e.filter((e=>!!e))),t.setRecords(e.filter((e=>!!e))))}getInfo(){return(0,c.getAppStore)().getState().dataSourcesInfo[this.id]||(0,c.Immutable)({})}clearRecords(){this.clearRecordsNotAddVersion(),this.addVersion()}clearRecordsNotAddVersion(){!this.isSelectionView()&&this.getSelectedRecords().length>0&&this.copySelectionToDataView([]),this.records=[]}getIdField(){return this.getSchema()&&this.getSchema().idField||"id"}getRootDataSource(){if(this.isDataView||this.isLocal)return this.getMainDataSource().getRootDataSource();let e=this.parentDataSource;for(;e&&e.parentDataSource;)e=e.parentDataSource;return e}ready(){return l(this,void 0,void 0,(function*(){return yield Promise.resolve({})}))}getOriginDataSources(){return this.isDataView||this.isLocal?this.getMainDataSource().getOriginDataSources():this.getDataSourceJson().originDataSources&&0!==this.getDataSourceJson().originDataSources.length?this.getDataSourceJson().originDataSources.asMutable().map((e=>this.dataSourceManager.getDataSource(e.dataSourceId))):[]}getMainDataSource(){var e;return this.belongToDataSource?null!==(e=this.belongToDataSource.belongToDataSource)&&void 0!==e?e:this.belongToDataSource:this}getDataViews(){return this.getMainDataSource()!==this?[]:this.dataSourceManager.getDataSourcesAsArray().filter((e=>e.belongToDataSource===this&&e.isDataView))}getDataView(e){return this.getDataViews().find((t=>t.dataViewId===e))}getLocalDataSources(){return this.isLocal?[]:this.dataSourceManager.getDataSourcesAsArray().filter((e=>e.belongToDataSource===this&&e.isLocal))}getLocalDataSource(e){return this.getLocalDataSources().find((t=>t.localId===e))}getAllDerivedDataSources(){let e=[];const t=this.getDataViews(),r=this.getLocalDataSources();return e=t.concat(r),t.forEach((t=>{e=e.concat(t.getLocalDataSources())})),e}getSaveStatus(){var e;return null===(e=(0,c.getAppStore)().getState().dataSourcesInfo[this.id])||void 0===e?void 0:e.saveStatus}setSaveStatus(e){(0,c.getAppStore)().dispatch(c.appActions.dataSourceSaveStatusChanged(this.id,e))}setListenSelection(e){this.listenSelection=e}getListenSelection(){return this.listenSelection}isSelectionView(){return this.isDataView&&this.dataViewId===c.CONSTANTS.SELECTION_DATA_VIEW_ID}isLocalViewOfSelectionView(){return this.isLocal&&this.dataViewId===c.CONSTANTS.SELECTION_DATA_VIEW_ID}addRecord(t){return l(this,void 0,void 0,(function*(){return t?(this.setSaveStatus(e.Saving),yield this.doAddRecord(t).then((t=>(this.setSaveStatus(e.Saved),t)),(t=>l(this,void 0,void 0,(function*(){return this.setSaveStatus(e.SaveError),yield Promise.reject(t)}))))):yield Promise.reject("No record passed in.")}))}doAddRecord(e){return l(this,void 0,void 0,(function*(){return this.getDataSourceJson().isDataInDataSourceInstance?yield this.doAddRecordToSourceRecords(e):yield Promise.reject("Editing source is not ready yet.")}))}updateRecord(e){return l(this,void 0,void 0,(function*(){return yield this.updateRecords([e])}))}updateRecords(t){return l(this,void 0,void 0,(function*(){return t&&0!==t.length?(this.setSaveStatus(e.Saving),yield this.doUpdateRecords(t).then((t=>(this.setSaveStatus(e.Saved),t)),(t=>l(this,void 0,void 0,(function*(){return this.setSaveStatus(e.SaveError),yield Promise.reject(t)}))))):yield Promise.reject("No records passed in.")}))}doUpdateRecords(e){return l(this,void 0,void 0,(function*(){return this.getDataSourceJson().isDataInDataSourceInstance?yield this.doUpdateRecordsInSourceRecords(e):yield Promise.reject("Editing source is not ready yet.")}))}deleteRecord(e){return l(this,void 0,void 0,(function*(){const t=this.getRecords()[e];return yield this.deleteOneRecord(t)}))}deleteRecordById(e){return l(this,void 0,void 0,(function*(){const t=this.getRecordById(e);return yield this.deleteOneRecord(t)}))}deleteOneRecord(t){return l(this,void 0,void 0,(function*(){return t?(this.setSaveStatus(e.Saving),yield this.doDeleteOneRecord(t).then((t=>(this.setSaveStatus(e.Saved),t)),(t=>l(this,void 0,void 0,(function*(){return this.setSaveStatus(e.SaveError),yield Promise.reject(t)}))))):yield Promise.reject("No record passed in.")}))}doDeleteOneRecord(e){return l(this,void 0,void 0,(function*(){return this.getDataSourceJson().isDataInDataSourceInstance?yield this.doDeleteOneRecordFromSourceRecords(e):yield Promise.reject("Editing source is not ready yet.")}))}doDeleteOneRecordFromSourceRecords(e){return l(this,void 0,void 0,(function*(){return this.sourceRecords=this.sourceRecords.filter((t=>t.getId()!==e.getId())),Promise.resolve(!0)}))}doAddRecordToSourceRecords(e){return l(this,void 0,void 0,(function*(){return this.sourceRecords=this.sourceRecords.concat(e),yield Promise.resolve(e)}))}doUpdateRecordsInSourceRecords(e){return l(this,void 0,void 0,(function*(){return e.forEach((e=>{const t=this.sourceRecords.findIndex((t=>t.getId()===e.getId()));t>-1&&(this.sourceRecords[t]=e)})),Promise.resolve(!0)}))}afterUpdateRecords(e){e&&0!==e.filter((e=>!!e)).length&&(this.updateLoadedRecords(this.getMainDataSource(),e),this.getMainDataSource().getAllDerivedDataSources().forEach((t=>this.updateLoadedRecords(t,e))),this.getMainDataSource().addSourceVersion())}updateLoadedRecords(e,t){const r=t.map((t=>e.getRecordById(t.getId())));r.filter((e=>!!e)).length>0&&(r.forEach(((e,r)=>{e&&(e.setData(t[r].getData()),e.setGeometry(t[r].getGeometry()))})),e.addVersion())}afterUpdateRecord(e){e&&(this.updateOneLoadedRecord(this.getMainDataSource(),e),this.getMainDataSource().getAllDerivedDataSources().forEach((t=>this.updateOneLoadedRecord(t,e))),this.getMainDataSource().addSourceVersion())}updateOneLoadedRecord(e,t){const r=e.getRecordById(t.getId());r&&(r.setData(t.getData()),r.setGeometry(t.getGeometry()),e.addVersion())}afterAddRecord(e){e&&(this.getMainDataSource().clearRecords(),this.getMainDataSource().getAllDerivedDataSources().forEach((e=>{e.clearRecords()})),this.getMainDataSource().addSourceVersion())}afterDeleteRecordById(e){e&&(this.getMainDataSource().getSelectedRecordIds().includes(e)&&this.getMainDataSource().selectRecordsByIds(this.getMainDataSource().getSelectedRecordIds().filter((t=>t!==e)),this.getMainDataSource().getSelectedRecords().filter((t=>t.getId()!==e))),this.deleteOneLoadedRecordById(this.getMainDataSource(),e),this.getMainDataSource().getAllDerivedDataSources().forEach((t=>this.deleteOneLoadedRecordById(t,e))),this.getMainDataSource().addSourceVersion())}deleteOneLoadedRecordById(e,t){const r=e.getRecords().findIndex((e=>(null==e?void 0:e.getId())===t));"number"==typeof r&&r>-1&&(e.getRecords().splice(r,1),e.addVersion())}destroy(){}}class S extends h{constructor(){super(...arguments),this.isDataSourceSet=!0}ready(){return e=this,t=void 0,i=function*(){return yield this.createChildDataSources()},new((r=void 0)||(r=Promise))((function(a,o){function s(e){try{d(i.next(e))}catch(e){o(e)}}function n(e){try{d(i.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,n)}d((i=i.apply(e,t||[])).next())}));var e,t,r,i}destroy(){this.getChildDataSources().forEach((e=>{e&&this.dataSourceManager.destroyDataSource(e.id)}))}getChildDataSourceId(e){return c.dataSourceUtils.getChildDataSourceId(this.id,e)}getChildDataSources(){return Object.keys(this.dataSourceManager.getDataSources()).filter((e=>this.dataSourceManager.getDataSource(e).parentDataSource===this)).map((e=>this.dataSourceManager.getDataSource(e))).sort(((e,t)=>e.order-t.order))}getChildDataSource(e){return this.dataSourceManager.getDataSource(this.getChildDataSourceId(e))}getJimuChildId(e){const t=this.getReversedConfigSchema();return t&&t.childSchemas&&t.childSchemas[e]?t.childSchemas[e].map((e=>e.jimuChildId)).asMutable():[e]}}var g=function(e,t,r,i){return new(r||(r=Promise))((function(a,o){function s(e){try{d(i.next(e))}catch(e){o(e)}}function n(e){try{d(i.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,n)}d((i=i.apply(e,t||[])).next())}))};class y extends S{constructor(e){super(e),e.layer&&(this.layer=e.layer)}ready(){const e=Object.create(null,{ready:{get:()=>super.ready}});return g(this,void 0,void 0,(function*(){return this.fetchServiceDefinition().then((()=>e.ready.call(this))).then((e=>{let t=(0,c.getAppStore)().getState().appConfig;const r=[],i=(e,t,r)=>((null==e?void 0:e.dataSourceId)&&(e.dataSourceId=e.dataSourceId.replace(t,r)),(null==e?void 0:e.mainDataSourceId)&&(e.mainDataSourceId=e.mainDataSourceId.replace(t,r)),e),a=(e,t)=>(null==e?void 0:e.mainDataSourceId)?e.mainDataSourceId===t:!!(null==e?void 0:e.dataSourceId)&&e.dataSourceId.split("-dataView_")[0]===t;if(e.forEach((e=>{var o,s,n,d,u,l,h;if(e){let S="",g=e;const y=[];for(;g;){const e=!g.parentDataSource,t=!g.isDataSourceSet&&!g.getDataSourceJson().url||c.dataSourceUtils.isSupportedSingleLayerService(g.getDataSourceJson().url),r=!!(null===(o=g.parentDataSource)||void 0===o?void 0:o.map);let i;if(e)i=g.id;else if(t&&!r){const e=g.getLayerDefinition?g.getLayerDefinition():null===(n=(s=g).getServiceDefinition)||void 0===n?void 0:n.call(s);i=c.dataSourceUtils._getFixedLayerIdByLayerDefinition(e)||g.jimuChildId}else i=t||r?g.jimuChildId:c.dataSourceUtils.getServiceLabelFromUrl(g.getDataSourceJson().url);if(!e&&!r&&g.getDataSourceJson().url&&(null===(h=null===(l=null===(u=null===(d=g.parentDataSource.layer)||void 0===d?void 0:d.layers)||void 0===u?void 0:u.toArray)||void 0===l?void 0:l.call(u))||void 0===h?void 0:h.filter((e=>c.dataSourceUtils.getUrlByLayer(e)===g.getDataSourceJson().url)).length)>1){const e=g.parentDataSource.layer.layers.toArray().filter((e=>c.dataSourceUtils.getUrlByLayer(e)===g.getDataSourceJson().url)).findIndex((e=>e.id===g.jimuChildId));e>0&&(i=`${i}_${e}`)}S=S?`${i}-${S}`:i,y.unshift({jimuChildIdFromLabel:i,jimuChildIdFromId:g.jimuChildId||g.id}),g=g.parentDataSource}Object.keys(t.widgets||{}).forEach((r=>{var o;if(null===(o=t.widgets[r].useDataSources)||void 0===o?void 0:o.some((e=>a(e,S)))){const a=t.widgets[r].asMutable({deep:!0});a.useDataSources=a.useDataSources.map((t=>i(t,S,e.id))),a.config&&(a.config=JSON.parse(JSON.stringify(a.config).replace(new RegExp(S,"g"),e.id))),t=t.setIn(["widgets",r],a)}})),Object.keys(t.dataSources||{}).forEach((r=>{var o;if(null===(o=t.dataSources[r].originDataSources)||void 0===o?void 0:o.some((e=>a(e,S)))){const a=t.dataSources[r].asMutable({deep:!0});a.originDataSources=a.originDataSources.map((t=>i(t,S,e.id))),t=t.setIn(["dataSources",r],a)}const s=[];if(y.forEach(((e,t)=>{s.push(e.jimuChildIdFromLabel),t!==y.length-1&&s.push("childDataSourceJsons")})),t.dataSources.getIn(s)){const r=y.slice().reverse();if(r[0].jimuChildIdFromId!==r[0].jimuChildIdFromLabel){const i=s.slice(0,s.length-2),a=t.dataSources.getIn(i).asMutable({deep:!0});a.childDataSourceJsons[r[0].jimuChildIdFromId]=a.childDataSourceJsons[r[0].jimuChildIdFromLabel],a.childDataSourceJsons[r[0].jimuChildIdFromId].id=e.id,delete a.childDataSourceJsons[r[0].jimuChildIdFromLabel],t=t.setIn(["dataSources"].concat(i),a)}}})),Object.keys(t.messageConfigs||{}).forEach((r=>{var o,s;const n=null===(o=t.messageConfigs[r].useDataSources)||void 0===o?void 0:o.some((e=>a(e,S))),d=null===(s=t.messageConfigs[r].actions)||void 0===s?void 0:s.some((e=>{var t,r,i,a;return(null===(r=null===(t=e.config)||void 0===t?void 0:t.actionUseDataSource)||void 0===r?void 0:r.mainDataSourceId)===S||(null===(a=null===(i=e.config)||void 0===i?void 0:i.messageUseDataSource)||void 0===a?void 0:a.mainDataSourceId)===S}));if(n||d){const a=t.messageConfigs[r].asMutable({deep:!0});n&&(a.useDataSources=a.useDataSources.map((t=>i(t,S,e.id)))),d&&(a.actions=a.actions.map((t=>{var r,a;return(null===(r=t.config)||void 0===r?void 0:r.actionUseDataSource)&&(t.config.actionUseDataSource=i(t.config.actionUseDataSource,S,e.id)),(null===(a=t.config)||void 0===a?void 0:a.messageUseDataSource)&&(t.config.messageUseDataSource=i(t.config.messageUseDataSource,S,e.id)),t}))),t=t.setIn(["messageConfigs",r],a)}})),!e.isDataSourceSet&&Object.keys((0,c.getAppStore)().getState().dataSourcesInfo).some((e=>e.includes(S)))&&(Object.keys((0,c.getAppStore)().getState().dataSourcesInfo).forEach((t=>{if(t.includes(S)){const r=t,i=t.replace(S,e.id);(0,c.getAppStore)().dispatch(c.appActions.updateDataSourceInfo(e.id,(0,c.getAppStore)().getState().dataSourcesInfo[r].merge((0,c.getAppStore)().getState().dataSourcesInfo[i]||{})))}})),e.getDataView(c.CONSTANTS.SELECTION_DATA_VIEW_ID)&&r.push(e.getDataView(c.CONSTANTS.SELECTION_DATA_VIEW_ID).ready()))}})),(0,c.getAppStore)().getState().appConfig!==t){(0,c.getAppStore)().dispatch(c.appActions.appConfigChanged(t));const e=this.getRootDataSource()||this,r=t.dataSources[e.id];r&&c.lodash.defer((()=>{this.dataSourceManager.updateDataSourceByDataSourceJson(e,r)}))}return Promise.allSettled(r).then((()=>e))}))}))}fetchSchema(){return g(this,void 0,void 0,(function*(){const e=this.getChildDataSources(),t=yield c.dataSourceUtils.getOriginDataLabel(this.getServiceDefinition(),this.layer,this);let r=(0,c.Immutable)({childSchemas:{},label:t});return e.forEach(((e,t)=>{const i=e.getFetchedSchema();r=r.setIn(["childSchemas",e.jimuChildId],i)})),Promise.resolve(r)}))}getServiceDefinition(){return this.isDataView||this.isLocal?this.getMainDataSource().getServiceDefinition():this.serviceDefinition}createChildDataSourcesByUrl(){return g(this,void 0,void 0,(function*(){if(!this.childDataSourcesPromise){let e;this.url&&(e=c.dataSourceUtils.fetchSupportedLayerDefinitions(this.url,this.getServiceDefinition())),this.childDataSourcesPromise=e?e.then((e=>g(this,void 0,void 0,(function*(){const t=[];let r=[];return Object.keys(e).filter((t=>c.dataSourceUtils.isLayerDefinitionTypeSupported(e[t]))).forEach((i=>{const a=this.getDsJsonsFromSingleLayerDefinition(c.dataSourceUtils.getDataSourceSourceUrl(i),e[i],r);r=r.concat(a),a.forEach((r=>{var a;const o={id:r.id,dataSourceJson:r,parentDataSource:this,jimuChildId:this.getJimuChildIdFromChildDsId(r.id),order:null===(a=e[i])||void 0===a?void 0:a.id};t.push(this.dataSourceManager.createDataSource(o))}))})),Promise.allSettled(t).then((e=>e.filter((e=>"fulfilled"===e.status)).map((e=>e.value))))})))):Promise.resolve([])}return this.childDataSourcesPromise}))}fetchServiceDefinitionByUrl(){return g(this,void 0,void 0,(function*(){return this.getServiceDefinition()?yield Promise.resolve(this.getServiceDefinition()):this.url?yield c.ServiceManager.getInstance().fetchServiceInfo(this.url).then((e=>e.definition)).then((e=>e?(e.name||(e.name=c.dataSourceUtils.getServiceLabelFromUrl(this.url)),this.serviceDefinition=e,this.serviceDefinition):null)):Promise.reject("Failed to fetch service definition, need url.")}))}getDsJsonsFromSingleLayerDefinition(e,t,i){if(!t)return[];const a=[];let o;const s=this.getJimuChildIdByJSAPILayerOrServiceDefinition(null,t,e,i),n=c.dataSourceUtils._getFixedLayerIdByLayerDefinition(t);return s.forEach((i=>{var s,d,u;const l=this.getDataSourceJson().schema?null===(s=this.getDataSourceJson().schema.childSchemas)||void 0===s?void 0:s[i]:null,h=this.getChildDataSourceId(i),S=(null===(d=this.getDataSourceJson().childDataSourceJsons)||void 0===d?void 0:d[i])||(null===(u=this.getDataSourceJson().childDataSourceJsons)||void 0===u?void 0:u[n]);c.dataSourceUtils.isSupportedSingleLayerService(e)?o=c.dataSourceUtils.getSingleDsJsonFromLayerDefinition(h,e,t,S):c.dataSourceUtils.isSupportedWholeService(e)?o=c.dataSourceUtils.getSingleDsJsonFromWholeServiceDefinition(h,e,t,S):e||t.type!==r.FeatureLayer||(o=c.dataSourceUtils.getSingleDsJsonFromLayerDefinition(h,e,t,S)),o&&(this.getDataSourceJson().portalUrl&&(o=o.set("portalUrl",this.getDataSourceJson().portalUrl)),this.getDataSourceJson().itemId&&(o=o.set("itemId",this.getDataSourceJson().itemId)),l&&(o=o.set("schema",l)),a.push(o))})),a}getJimuChildIdFromChildDsId(e){return e.split(`${this.id}-`)[1]}getJimuChildIdByJSAPILayerOrServiceDefinition(e,t,r,i){let a;if(e){const t=c.dataSourceUtils.getFixedLayerIdByLayer(e)||c.dataSourceUtils.getServiceLabelFromUrl(r);a=this.getJimuChildId(t)}else if(t){const e=c.dataSourceUtils.getFixedLayerIdByLayerDefinition(t)||c.dataSourceUtils.getServiceLabelFromUrl(r);a=this.getJimuChildId(e)}else a=[];const o={},s=i.map((e=>this.getJimuChildIdFromChildDsId(e.id)));a.forEach(((e,t)=>{o[e]||(o[e]={isSameAsExistedJimuChildId:s.some((t=>t===e)),indexes:[]}),o[e].indexes.push(t)}));let n=[];return Object.keys(o).forEach((e=>{o[e].isSameAsExistedJimuChildId||1!==o[e].indexes.length?!o[e].isSameAsExistedJimuChildId&&o[e].indexes.length>1?o[e].indexes.forEach((t=>{n=0===t?n.concat(e):n.concat(`${e}_${t}`)})):o[e].isSameAsExistedJimuChildId&&o[e].indexes.forEach((t=>{const r=1+s.filter((t=>/^[0-9]+?$/.test(t.split(`${e}_`)[1]))).length;n=n.concat(`${e}_${t+r}`)})):n=n.concat(e)})),n}}class v extends h{load(){return t=this,r=void 0,a=function*(){return this.setStatus(e.Loading),yield this.doLoad().then((t=>(this.records=t,this.setStatus(e.Loaded),this.records)))},new((i=void 0)||(i=Promise))((function(e,o){function s(e){try{d(a.next(e))}catch(e){o(e)}}function n(e){try{d(a.throw(e))}catch(e){o(e)}}function d(t){var r;t.done?e(t.value):(r=t.value,r instanceof i?r:new i((function(e){e(r)}))).then(s,n)}d((a=a.apply(t,r||[])).next())}));var t,r,i,a}}var f=function(e,t,r,i){return new(r||(r=Promise))((function(a,o){function s(e){try{d(i.next(e))}catch(e){o(e)}}function n(e){try{d(i.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,n)}d((i=i.apply(e,t||[])).next())}))};const{DEFAULT_QUERY_PAGE_SIZE:m,DATA_VIEW_ID_FOR_NO_SELECTION:p,OUTPUT_DATA_VIEW_ID:D,SELECTION_DATA_VIEW_ID:I}=c.CONSTANTS;class R extends h{constructor(t){super(t),this.pages={},this.pagePromises={},this.throttleQueryRecordsByIdWithCurrentQueryParams=c.lodash.throttle(this.queryRecordsByIdWithCurrentQueryParams,200),this.url=this.getDataSourceJson().url;const r=t.belongToDataSource&&t.belongToDataSource.getStatus()!==e.NotReady;this.getDataSourceJson().isOutputFromWidget&&!r?(this.setStatus(e.NotReady),this.setCountStatus(e.NotReady)):(this.setStatus(e.Unloaded),this.setCountStatus(e.Unloaded))}ready(){var e,t;if(this.isSelectionView()){const r=this.getMainDataSource().id,i=(0,c.getAppStore)().getState().dataSourcesInfo;let a=(null===(t=null===(e=null==i?void 0:i[r])||void 0===e?void 0:e.selectedIds)||void 0===t?void 0:t.asMutable())||[];return i&&Object.keys(i).forEach((e=>{var t,o;if(c.dataSourceUtils.isDerivedFrom(r,e)){const r=(null===(o=null===(t=i[e])||void 0===t?void 0:t.selectedIds)||void 0===o?void 0:o.asMutable())||[];a=a.concat(r)}})),a=Array.from(new Set(a)),0===a.map((e=>+e)).filter((e=>!isNaN(e))).length?Promise.resolve({}):this.queryRecordsByIdWithCurrentQueryParams(a,this.getMainDataSource()).then((e=>{var t;this.getMainDataSource().selectRecordsByIds(null===(t=e.records)||void 0===t?void 0:t.map((e=>e.getId())),e.records)})).catch((e=>{console.error(`Failed set selected records in URL to selection view ${this.id}.`,e)}))}return this.isDataView&&this.dataViewId===p?Promise.allSettled([this.load({returnGeometry:!0},{widgetId:p}),this.loadCount({},{widgetId:p})]).then((()=>{var e,t,r;0===this.getMainDataSource().getSelectedRecordIds().filter((e=>!!e)).length&&(null===(e=this.getMainDataSource().getDataView(I))||void 0===e||e.clearRecords(),null===(r=null===(t=this.getMainDataSource().getDataView(I))||void 0===t?void 0:t.getAllDerivedDataSources())||void 0===r||r.forEach((e=>{null==e||e.clearRecords()})))})):Promise.resolve({})}getCurrentQueryParams(e){const t=this.getRuntimeQueryParams(e&&e.dataSourceId===this.id?null==e?void 0:e.widgetId:null);return this.getCurrentQueryParamsByQuery(t,e)}getRuntimeQueryParams(e){var t;const r=e?null===(t=this.getInfo().widgetQueries)||void 0===t?void 0:t.without(e):this.getInfo().widgetQueries;return this.getMergedWidgetQueries(r)}getCurrentQueryParamsByQuery(e,t){let r;return this.isLocal?r=this.mergeQueryParams(this.belongToDataSource.getCurrentQueryParams(t),e):this.isDataView?(r=this.mergeQueryParams(this.getConfigQueryParams(),e),r=this.mergeQueryParams(this.getMainDataSource().getCurrentQueryParams(t),r)):(r=this.mergeQueryParams(this.getConfigQueryParams(),e),r=this.mergeQueryParams(this.getRemoteQueryParams(),r)),r}getMergedWidgetQueries(e){let t=e&&Object.keys(e)||[];return t=t.sort(((e,t)=>e.localeCompare(t))),this.mergeQueryParams(...t.map((t=>e[t])))}getCurrentQueryId(){return this.lastQueryId}getRealQueryParams(e,t,r){let i;if("query"===t)r&&r.scope?r.scope===d.InAllData?i=e:r.scope===d.InRemoteConfigView?i=this.mergeQueryParams(this.getRemoteQueryParams(),e):r.scope===d.InConfigView?(i=this.mergeQueryWithConfigQuery(e),i=this.mergeQueryParams(this.getRemoteQueryParams(),i)):i=r.scope===d.InRuntimeView?this.mergeQueryParams(this.getCurrentQueryParams(r.excludeQuery),e):e:i=this.mergeQueryParams(this.getCurrentQueryParams(null==r?void 0:r.excludeQuery),e);else{if(!r||!r.widgetId)return console.error("Please pass widget id for load."),null;const t=()=>{let t,i=this.getInfo().widgetQueries||(0,c.Immutable)({});return(null==r?void 0:r.excludeQuery)&&(i=i.without(r.excludeQuery.widgetId)),i=i.set(r.widgetId,e),t=this.getMergedWidgetQueries(i),t=this.getCurrentQueryParamsByQuery(t,null==r?void 0:r.excludeQuery),t};r&&r.scope?r.scope===d.InAllData?i=e:r.scope===d.InRemoteConfigView?i=this.mergeQueryParams(this.getRemoteQueryParams(),e):r.scope===d.InConfigView?(i=this.mergeQueryWithConfigQuery(e),i=this.mergeQueryParams(this.getRemoteQueryParams(),i)):i=r.scope===d.InRuntimeView?t():e:i=t()}return i}getDataViewConfig(){return this.isLocal?this.belongToDataSource.getDataViewConfig():this.isDataView?this.getDataSourceJson().dataViews&&this.getDataSourceJson().dataViews[this.dataViewId]:this.getDataSourceJson().query}mergeQueryWithConfigQuery(e){let t;return this.isLocal?this.belongToDataSource.isDataView?(t=this.mergeQueryParams(this.belongToDataSource.getConfigQueryParams(),e),t=this.mergeQueryParams(this.getMainDataSource().getConfigQueryParams(),t)):t=this.mergeQueryParams(this.getConfigQueryParams(),e):this.isDataView?(t=this.mergeQueryParams(this.getConfigQueryParams(),e),t=this.mergeQueryParams(this.getMainDataSource().getConfigQueryParams(),t)):t=this.mergeQueryParams(this.getConfigQueryParams(),e),t}updateQueryParams(e,t){e=this.getQueryWithoutPage(e),c.utils.isDeepEqual(e,this.getInfo().widgetQueries&&this.getInfo().widgetQueries[t])||((0,c.getAppStore)().dispatch(c.appActions.updateWidgetQuery(this.id,t,e)),this.isSelectionView()&&(this.load({returnGeometry:!0},{widgetId:I}),this.loadCount({},{widgetId:I})))}getQueryPageSize(){var e;return(null===(e=this.getDataViewConfig())||void 0===e?void 0:e.pageSize)||m}getMaxRecordCount(){var e;return(null===(e=this.getDataViewConfig())||void 0===e?void 0:e.maximum)||null}getQueryWithoutPage(e){if(!e)return null;const{pageSize:t,page:r}=e;return function(e,t){var r={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(r[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var a=0;for(i=Object.getOwnPropertySymbols(e);a<i.length;a++)t.indexOf(i[a])<0&&Object.prototype.propertyIsEnumerable.call(e,i[a])&&(r[i[a]]=e[i[a]])}return r}(e,["pageSize","page"])}checkClearLocalCache(e,t,r){const i=this.getQueryWithoutPage(e),a=this.getRealQueryParams(i,"load",r),o=r.refresh||this.getInfo().needRefresh;return!(c.utils.isDeepEqual(a,t)&&!o)}getRecordsByPage(e,t){const r=[],i=Object.assign({},this.pages),a=Object.keys(i).map((e=>parseInt(e))).sort(((e,t)=>t-e))[0],o=this.getQueryPageSize();let s=t*(e-1),n=s+t-1;const d=this.getMaxRecordCount();if(null!==d){if(s>d-1)return r;s=Math.min(s,d-1),n=Math.min(n,d-1)}for(let e=1;e<=a;e++){const t=(e-1)*o;if(!(t+o-1<s||t>n)&&i[e])for(let a=0;a<i[e].length;a++)t+a<s||t+a>n||r.push(i[e][a])}return r}getRecordsByPageWithSelection(e,t){return this.concatRecordsAndSelection(this.getRecordsByPage(e,t),this.getSelectedRecords())}getPagesData(){return this.pages}setPagesData(e){this.pages=e}clearRecordsNotAddVersion(){!this.isSelectionView()&&this.getSelectedRecords().length>0&&this.copySelectionToDataView([]),this.pages={},this.pagePromises={},this.count=null,this.countPromise=null,this.byIdPromise=null}getRecords(){let e=[];const t=[];for(let e=1;e<=Object.keys(this.pages).length&&this.pages[e];e++)t.push(e);return t.forEach((t=>{e=e.concat(this.pages[t])})),null!==this.getMaxRecordCount()&&this.getMaxRecordCount()<e.length?e.slice(0,this.getMaxRecordCount()):e}setRecords(e){const t={},r=this.getQueryPageSize();e.forEach(((e,i)=>{const a=Math.ceil((i+1)/r);t[a]||(t[a]=[]),t[a][(i+1)%r-1]=e})),this.setPagesData(t),this.addVersion()}get count(){return this._count}set count(e){this._count=e}getRealQueryPages(e,t){const r=t*(e-1);let i=r+t-1;null!==this.getMaxRecordCount()&&(i=Math.min(i,this.getMaxRecordCount()-1));const a=Math.floor(r/this.getQueryPageSize())+1,o=Math.floor(i/this.getQueryPageSize())+1,s=[];for(let e=a;e<=o;e++)s.push(e);return s}load(t,r={}){return f(this,void 0,void 0,(function*(){if(this.getStatus()===e.NotReady)return yield Promise.resolve([]);(t=Object.assign({},t)).page||(t.page=1),t.pageSize||(t.pageSize=this.getQueryPageSize());const i=this.getRealQueryPages(t.page,t.pageSize);this.checkClearLocalCache(t,this.lastQueryParams,r)&&(Object.keys(this.pages).forEach((e=>{i.includes(parseInt(e))||delete this.pages[e]})),this.pagePromises={},this.count=null,this.countPromise=null),this.updateQueryParams(t,r.widgetId);const a=this.getQueryWithoutPage(t),o=this.getRealQueryParams(a,"load",r),s=i.filter((e=>this.pagePromises[e])).map((e=>this.pagePromises[e]));return s.length===i.length?yield Promise.all(s).then((()=>this.getRecordsByPage(t.page,t.pageSize))):(this.lastQueryParams=o,this.setStatus(e.Loading),(0,c.getAppStore)().dispatch(c.appActions.setDataNeedRefresh(this.id,!1)),Promise.all(i.map((e=>f(this,void 0,void 0,(function*(){return yield this.loadByPage(o,t,e)}))))).then((r=>{if(!r.find((e=>e)))return[];const i=this.isDataView&&this.dataViewId===p,a=this.isSelectionView(),o=this.isLocalViewOfSelectionView();if(!i&&!a&&!o){let e=[];const t=this.getDataSourceJson().isDataInDataSourceInstance?this.getSourceRecords():this.getRecords();this.getSelectedRecordIds().length>0?e=this.getSelectedRecordIds().map((e=>t.filter((t=>t&&t.getId()===e))[0])):this.getSelectedRecordIndexes().length>0&&(e=this.getSelectedRecordIndexes().map((e=>t[e]))),e.filter((e=>!!e)).length>0&&this.copySelectionToDataView(e)}return this.isSelectionView()&&this.getMainDataSource().getSelectedRecordIds().filter((e=>!!e)).length>0&&this.getMainDataSource().updateSelectionStateAndChangeUrl("byId",this.getRecords().map((e=>e.getId()))),this.lastRefreshTime=new Date,this.setStatus(e.Loaded),window.jimuConfig.isInBuilder&&(0,c.getAppStore)().getState().appRuntimeInfo.appMode===c.AppMode.Design||this.startAutoRefresh(),this.getRecordsByPage(t.page,t.pageSize)}),(t=>(console.error(t),this.setStatus(e.LoadError),[]))))}))}loadByPage(e,t,r){return f(this,void 0,void 0,(function*(){if(this.pagePromises[r])return yield this.pagePromises[r];const i=Object.assign(Object.assign({},e),{page:r,pageSize:this.getQueryPageSize()});return this.pagePromises[r]=this.doQuery((0,c.Immutable)(i),(0,c.Immutable)(t)).then((e=>{const t=this.getQueryWithoutPage(e.queryParams);return!(!c.utils.isDeepEqual(t,this.lastQueryParams)||"number"==typeof e.sourceVersion&&e.sourceVersion!==this.getSourceVersion()||(this.pages[e.queryParams.page]=e.records,0))})),this.pagePromises[r]}))}loadCount(t,r={}){return f(this,void 0,void 0,(function*(){if(this.getCountStatus()===e.NotReady)return yield Promise.resolve(0);if(!this.checkClearLocalCache(t,this.lastCountQueryParams,r)&&this.countPromise)return this.countPromise;const i=this.getRealQueryParams(this.getQueryWithoutPage(t),"load",r);return this.lastCountQueryParams=i,this.setCountStatus(e.Loading),this.countPromise=this.doQueryCount((0,c.Immutable)(i)).then((t=>!c.utils.isDeepEqual(t.queryParams,this.lastCountQueryParams)||"number"==typeof t.sourceVersion&&t.sourceVersion!==this.getSourceVersion()?null:(null===this.getMaxRecordCount()?this.count=t.count:this.count=Math.min(t.count,this.getMaxRecordCount()),this.setCountStatus(e.Loaded),this.count)),(t=>f(this,void 0,void 0,(function*(){return console.error(t),this.setCountStatus(e.LoadError),yield Promise.reject(t)})))),this.countPromise}))}query(t,r){return f(this,void 0,void 0,(function*(){if(this.getStatus()===e.NotReady)return yield Promise.resolve({queryParams:(0,c.Immutable)(t),records:[],fields:[],sourceVersion:this.getSourceVersion()});const i=this.getRealQueryParams(t,"query",r);return yield this.doQuery((0,c.Immutable)(i),(0,c.Immutable)(t)).then((e=>{const t=this.getMaxRecordCount();if(null===t)return e;const r=e.queryParams.page||1,i=e.queryParams.pageSize;return 1!==r&&i?(r-1)*i>t?e.records=[]:(r-1)*i+e.records.length>t&&(e.records=e.records.slice(0,(r-1)*i+e.records.length-t)):e.records.length>t&&(e.records=e.records.slice(0,t)),e}))}))}queryCount(t,r){return f(this,void 0,void 0,(function*(){if(this.getCountStatus()===e.NotReady)return yield Promise.resolve({queryParams:(0,c.Immutable)(t),count:0,sourceVersion:this.getSourceVersion()});if(this.isSelectionView()&&0===this.getSourceRecords().length){const e=this.getMainDataSource().getDataView(c.CONSTANTS.DATA_VIEW_ID_FOR_NO_SELECTION);if(e)return yield e.queryCount(t,r)}const i=this.getRealQueryParams(t,"query",r);return yield this.doQueryCount((0,c.Immutable)(i)).then((e=>(null===this.getMaxRecordCount()||(e.count=Math.min(e.count,this.getMaxRecordCount())),e)))}))}loadById(t,r){return f(this,void 0,void 0,(function*(){return this.getStatus()===e.NotReady?yield Promise.resolve(null):(t===this.lastQueryId&&!r&&this.byIdPromise||(this.lastQueryId=t,this.setStatus(e.Loading),this.byIdPromise=this.doQueryById(t).then((t=>(this.setStatus(e.Loaded),t)),(t=>(console.error(t),this.setStatus(e.LoadError),null)))),this.byIdPromise)}))}queryById(t){return f(this,void 0,void 0,(function*(){return this.getStatus()===e.NotReady?yield Promise.resolve(null):yield this.doQueryById(t)}))}getAutoRefreshInterval(){const e=this.getMainDataSource();let t=e.getDataViewConfig()&&e.getDataViewConfig().refreshInterval;return 0===t?0:(null==t&&(t=e.getSchema().refreshInterval),t)}getLastRefreshTime(){return this.lastRefreshTime}startAutoRefresh(){const e=this.getAutoRefreshInterval();e&&(this.autoRefreshHandle||((0,c.getAppStore)().dispatch(c.appActions.setDataNeedRefresh(this.id,!1)),this.autoRefreshHandle=setTimeout((()=>{this.stopAutoRefresh(),(0,c.getAppStore)().dispatch(c.appActions.setDataNeedRefresh(this.id,!0))}),1e3*e)))}stopAutoRefresh(){this.autoRefreshHandle&&(clearTimeout(this.autoRefreshHandle),this.autoRefreshHandle=null)}getMainDataSource(){return super.getMainDataSource()}getDataViews(){return super.getDataViews()}getDataView(e){return super.getDataView(e)}setSelectedRecordIdsToInfo(e,t){if(!e)return;if(!this.getListenSelection()&&this.id!==(null==t?void 0:t.id))return;const r=!this.isLocal&&!this.isDataView,i=this.dataViewId===D;if(r||i||0===e.length)return void(0,c.getAppStore)().dispatch(c.appActions.dataSourceSelectedIdsChanged(this.id,e));const a=this.getRecords(),o=this.getSelectedRecordIds();let s=[],n=[];e.forEach((e=>{a.some((t=>(null==t?void 0:t.getId())===e))||o.some((t=>t===e))?n=n.concat(e):s=s.concat(e)})),n.length!==e.length?this.throttleQueryRecordsByIdWithCurrentQueryParams(s).then((e=>{const t=s.filter((t=>{var r;return null===(r=null==e?void 0:e.records)||void 0===r?void 0:r.some((e=>(null==e?void 0:e.getId())===t))}));(0,c.getAppStore)().dispatch(c.appActions.dataSourceSelectedIdsChanged(this.id,n.concat(t)))})).catch((e=>{console.error(`Failed to check whether selected records in ${this.id}. `,e)})):(0,c.getAppStore)().dispatch(c.appActions.dataSourceSelectedIdsChanged(this.id,e))}queryRecordsByIdWithCurrentQueryParams(e,t){return f(this,void 0,void 0,(function*(){const r=e.map((e=>+e)).filter((e=>!isNaN(e))),i=this.getCurrentQueryParams(),a=this.mergeQueryParams(i,{objectIds:r});return t?t.query(a):this.query(a)}))}deleteOneLoadedRecordById(e,t){var r;const i=e.getPagesData(),a=Object.keys(i).find((e=>{var r;return null===(r=i[e])||void 0===r?void 0:r.some((e=>(null==e?void 0:e.getId())===t))})),o=null===(r=i[a])||void 0===r?void 0:r.findIndex((e=>(null==e?void 0:e.getId())===t));"number"==typeof o&&o>-1&&(i[a].splice(o,1),e.addVersion())}}class A{getFieldValue(e){return this.getData()[e]}getFormattedFieldValue(e,t){const r=this.dataSource.getSchema().fields[e];if(!r)return this.getFieldValue(e);if(r.format)switch(r.type){case c.JimuFieldType.Date:return this.formatDateField(this.getFieldValue(e),r.format.dateFormat,t);case c.JimuFieldType.Number:return this.formatNumberField(this.getFieldValue(e),r.format.places,r.format.digitSeparator,t);default:return this.getFieldValue(e)}else switch(r.type){case c.JimuFieldType.Date:return null!==this.getFieldValue(e)&&void 0!==this.getFieldValue(e)?t.formatDate(this.getFieldValue(e)):null;case c.JimuFieldType.Number:return null!==this.getFieldValue(e)&&void 0!==this.getFieldValue(e)?t.formatNumber(this.getFieldValue(e)):null;default:return this.getFieldValue(e)}}convertBeforeMappingDataToData(e){const t={},r=this.dataSource.getReversedConfigSchema();return Object.keys(e).forEach((i=>{const a=r&&r.fields&&r.fields[i];a?a.forEach((r=>{t[r.jimuName]=e[i]})):t[i]=e[i]})),t}convertDataToDataBeforeMapping(e){const t={},r=this.dataSource.getSchema();return Object.keys(e).forEach((i=>{const a=r&&r.fields&&r.fields[i]?r.fields[i].name:i;t[a]=e[i]})),t}getFormattedData(e){const t={};return Object.keys(this.getData()).forEach((r=>{t[r]=this.getFormattedFieldValue(r,e)})),t}formatDateField(e,t,r){if(!e)return null;"number"==typeof e&&(e=new Date(e));const i=c.dateUtils.ESRI_DATE_FORMAT_MAP[t];if(!i)return console.warn(`Invalid data format ${t}`),null;let a=c.dateUtils.formatDate(e,i.datePattern,r);if("date and time"===i.selector){const t=c.dateUtils.formatTime(e,i.timePattern,r),o=r.locale||"en";a=a+(c.dateUtils.DATE_TIME_CONNECTOR[o]||c.dateUtils.DATE_TIME_CONNECTOR.common)+t}return a}formatNumberField(e,t,r,i){if(null==e)return null;const a=new Number(e);return r?i.formatNumber(e,{maximumFractionDigits:t,minimumFractionDigits:t}):a.toFixed(t)}}class P extends A{constructor(e,t,r=!0){super(),this.dataSource=t,this.data=r?this.convertBeforeMappingDataToData(e):e}getData(){return this.data}setData(e){this.data=e}getDataBeforeMapping(){return this.convertDataToDataBeforeMapping(this.data)}toJson(){return this.data}getId(){return this.data.id}setId(){}getGeometry(){return null}setGeometry(e){}}class C{constructor(e){Object.assign(this,e)}}var L=function(e,t,r,i){return new(r||(r=Promise))((function(a,o){function s(e){try{d(i.next(e))}catch(e){o(e)}}function n(e){try{d(i.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,n)}d((i=i.apply(e,t||[])).next())}))};class b extends A{constructor(e,r,i=!0){var a;super();const o=(null==r?void 0:r.type)===t.FeatureLayer&&(null===(a=r)||void 0===a?void 0:a.getAssociatedDataSource());this.dataSource=o||r,i?(e.attributes=this.convertBeforeMappingDataToData(e.attributes),this.feature=e):this.feature=e,this.fillGeometry()}fillGeometry(){var e;if(!this.feature.geometry)return;const t=this.dataSource;this.feature.geometry.spatialReference||(this.feature.geometry.spatialReference=null===(e=t.getLayerDefinition().extent)||void 0===e?void 0:e.spatialReference)}queryAttachments(e){return L(this,void 0,void 0,(function*(){let t=null;const r=this.dataSource;if(t=r&&r.getMainDataSource().url,!t)return yield Promise.resolve([]);const i={attachmentTypes:e,url:t,featureId:this.getId()};return this._queryAllAttachmentsPromise||(this._queryAllAttachmentsPromise=c.dataSourceUtils.queryAllAttachments(i)),yield this._queryAllAttachmentsPromise.then((e=>L(this,void 0,void 0,(function*(){return this.attachmentInfos=e,yield c.dataSourceUtils.filterAttachments(e,i)}))))}))}getSymbolPreviewHTML(){return L(this,void 0,void 0,(function*(){return this._isGraphicFeature()?(this._getSymbolPreviewHTMLPromise||(this._getSymbolPreviewHTMLPromise=(0,c.loadArcGISJSAPIModules)(["esri/symbols/support/symbolUtils"]).then((e=>L(this,void 0,void 0,(function*(){let t=null;return[t]=e,yield t.getDisplayedSymbol(this.feature).then((e=>L(this,void 0,void 0,(function*(){const r=document.createElement("div");return r.className="w-100 h-100 d-flex justify-content-center align-items-center",yield t.renderPreviewHTML(e,{node:r})}))))}))))),yield this._getSymbolPreviewHTMLPromise):yield Promise.resolve(null)}))}getData(){return this.feature.attributes}setData(e){this.feature.attributes=e}getFormattedFieldValue(e,t){const r=this.dataSource,i=r&&r.getLayerDefinition&&r.getLayerDefinition();if(!i)return super.getFormattedFieldValue(e,t);const a=c.dataSourceUtils.getDisplayValueForCodedValueOrSubtype(i,e,this.getData());return a.isCodedValueOrSubtype?a.displayValue:super.getFormattedFieldValue(e,t)}getDataBeforeMapping(){return this.convertDataToDataBeforeMapping(this.getData())}getOriginData(){const e=Object.assign({},this.feature);return e.attributes=this.convertDataToDataBeforeMapping(this.getData()),e}toJson(){return this.feature}getId(){return this.feature.attributes[this.dataSource.getIdField()]+""}setId(e){}getGeometry(){return"esri.Graphic"===this.feature.declaredClass?this.feature.toJSON().geometry:this.feature.geometry}setGeometry(e){this.feature.geometry=e}setFeature(e){this.feature=e,this.fillGeometry()}getFeature(){return this.feature}_isGraphicFeature(){var e;return!!(null===(e=null==this?void 0:this.feature)||void 0===e?void 0:e.layer)}}var w=function(e,t,r,i){return new(r||(r=Promise))((function(a,o){function s(e){try{d(i.next(e))}catch(e){o(e)}}function n(e){try{d(i.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,n)}d((i=i.apply(e,t||[])).next())}))};class V extends v{constructor(r){super(r),this.type=t.CSV,r.dataSourceJson.data?(this.records=r.dataSourceJson.data.asMutable().map((e=>new P(e,this))),this.setStatus(e.Loaded)):this.url=r.dataSourceJson.url}doLoad(){return w(this,void 0,void 0,(function*(){return yield fetch(this.url).then((e=>w(this,void 0,void 0,(function*(){return yield e.json()})))).then((e=>e.map((e=>new P(e,this)))))}))}}var F=function(e,t,r,i){return new(r||(r=Promise))((function(a,o){function s(e){try{d(i.next(e))}catch(e){o(e)}}function n(e){try{d(i.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,n)}d((i=i.apply(e,t||[])).next())}))};class E extends R{constructor(e){super(e),this.type=t.FeatureLayer;const r=this.getDataSourceJson();this.portalUrl=r.portalUrl,this.itemId=r.itemId,this.layerId=r.layerId,this.getDataSourceJson().isDataInDataSourceInstance?(this.url=null,this.itemId=null,this.portalUrl=null,this.layer=null,this.layerId=null):e.layer?this.layer=e.layer:e.belongToDataSource&&e.belongToDataSource.layer&&(this.layer=e.belongToDataSource.layer),e.associatedDataSource&&this.setAssociatedDataSource(e.associatedDataSource)}setAssociatedDataSource(e){this.associatedDataSource=e}getAssociatedDataSource(){return this.associatedDataSource}setSourceRecords(e){super.setSourceRecords(e),this.canSaveSource()&&(this.sourceRecords=e.filter((e=>!!e)).map((e=>this.fixRecordDataSource(e))))}getSourceRecords(){let e=super.getSourceRecords();return this.useNoSelectionView()&&(e=e.map((e=>this.fixRecordDataSource(e)))),e}fixRecordDataSource(e){const t=this.getAssociatedDataSource();return e.dataSource=t||this,e}getIdField(){return this.getSchema().idField}getGeometryType(){const e=this.getLayerDefinition();return(null==e?void 0:e.type)===r.Table?null:this.getDataSourceJson().geometryType||(null==e?void 0:e.geometryType)}setJsonData(e){this.records=e.map((e=>new b(e,this,!1)))}doQuery(e,t){return F(this,void 0,void 0,(function*(){let r={queryParams:e,records:[],sourceVersion:this.getSourceVersion()};if(this.getDataSourceJson().isDataInDataSourceInstance){if(this.getSourceRecords().length>0){const t=this.getSourceRecords();r=this.isQueryParamsEmpty(e)?{queryParams:e,records:t,sourceVersion:this.getSourceVersion()}:yield c.dataSourceUtils.createFeatureLayerByRecords(this,t,this.getSourceVersion()).then((({layer:t,sourceVersion:r})=>F(this,void 0,void 0,(function*(){this.layer=t;const i=yield this.doQueryByLayer(e);return Object.assign(Object.assign({},i),{sourceVersion:r})}))))}}else r=this.layer?yield this.doQueryByLayer(e):this.url?yield this.doQueryByUrl(e):yield this.createLayerByItemId().then((()=>F(this,void 0,void 0,(function*(){return yield this.doQueryByLayer(e)}))));return r=this.enhanceQueryResult(r,t),r}))}isQueryParamsEmpty(e){if(!e)return!0;const t=e.without("page").without("pageSize").without("returnGeometry");if(0===Object.keys(t).length)return!0;const r="string"==typeof t.where?t.where.replace(/\s+/g,"").replace(/\(/g,"").replace(/\)/g,""):null;return 1===Object.keys(t).length&&["","1=1"].some((e=>e===r))}enhanceQueryResult(e,t){var r,i,a;let o=null===(r=e.records)||void 0===r?void 0:r.slice();if(!o)return e;let s=e.queryParams;if((null==t?void 0:t.outStatistics)&&((null===(i=null==t?void 0:t.orderByFields)||void 0===i?void 0:i.length)>0&&(o=this.sortRecordsByFields(o,t.orderByFields),s=s.set("orderByFields",t.orderByFields)),"number"==typeof(null==t?void 0:t.pageSize))){const e=null!==(a=t.page)&&void 0!==a?a:1;o=this.sliceRecordsByPage(o,t.pageSize,e),s=s.set("pageSize",t.pageSize),s=s.set("page",e)}return Object.assign(Object.assign({},e),{records:o,queryParams:s})}sliceRecordsByPage(e,t,r){const i=t*(r-1),a=i+t;return e.slice(i,a)}sortRecordsByFields(e,t){return e.filter((e=>!!e)).sort(((e,r)=>this.compareRecordsByFields(e,r,t)))}compareRecordsByFields(e,t,r){var i,a;let o=0,s=0;for(;o<r.length;){const n=r[o].split(" ")[0];let d=0;if(r[o].split(" ").length>2)d=0;else if(typeof e.getFieldValue(n)!=typeof t.getFieldValue(n)){const r=null===(a=null===(i=this.getSchema())||void 0===i?void 0:i.fields)||void 0===a?void 0:a[n],o=((null==r?void 0:r.type)||c.JimuFieldType.Number)===c.JimuFieldType.String?"string":"number",s=typeof e.getFieldValue(n)===o,u=typeof t.getFieldValue(n)===o;d=s&&!u?1:!s&&u?-1:0}else{const r=e.getFieldValue(n),i=t.getFieldValue(n);d=this.getCompareValueResult(r,i)}if(s="DESC"===r[o].split(" ")[1]?-d:d,0!==s)break;o++}return s}getCompareValueResult(e,t){let r=0;return"string"==typeof e&&"string"==typeof t?r=e.localeCompare?e.localeCompare(t):0:"number"==typeof e&&"number"==typeof t&&(r=e-t),r}doQueryCount(e){return F(this,void 0,void 0,(function*(){if(this.getDataSourceJson().isDataInDataSourceInstance){if(0===this.getSourceRecords().length)return yield Promise.resolve({queryParams:e,count:0,sourceVersion:this.getSourceVersion()});const t=this.getSourceRecords();return this.isQueryParamsEmpty(e)?Promise.resolve({queryParams:e,count:t.length,sourceVersion:this.getSourceVersion()}):yield c.dataSourceUtils.createFeatureLayerByRecords(this,t,this.getSourceVersion()).then((({layer:t,sourceVersion:r})=>F(this,void 0,void 0,(function*(){this.layer=t;const i=yield this.doQueryCountByLayer(e);return Object.assign(Object.assign({},i),{sourceVersion:r})}))))}return this.layer?yield this.doQueryCountByLayer(e):this.url?yield this.doQueryCountByUrl(e):yield this.createLayerByItemId().then((()=>F(this,void 0,void 0,(function*(){return yield this.doQueryCountByLayer(e)}))))}))}doAddRecordToServerSideSource(e){return F(this,void 0,void 0,(function*(){return this.layer?yield this.addRecordByLayer(e):this.url?yield this.addRecordByUrl(e):yield this.createLayerByItemId().then((()=>F(this,void 0,void 0,(function*(){return yield this.addRecordByLayer(e)}))))}))}doDeleteOneRecordFromServerSideSource(e){return F(this,void 0,void 0,(function*(){return this.layer?yield this.deleteOneRecordByLayer(e):this.url?yield this.deleteOneRecordByUrl(e):yield this.createLayerByItemId().then((()=>F(this,void 0,void 0,(function*(){return yield this.deleteOneRecordByLayer(e)}))))}))}doUpdateRecordsInServerSideSource(e){return F(this,void 0,void 0,(function*(){return this.layer?yield this.updateRecordsByLayer(e):this.url?yield this.updateRecordsByUrl(e):yield this.createLayerByItemId().then((()=>F(this,void 0,void 0,(function*(){return yield this.updateRecordsByLayer(e)}))))}))}doQueryCountByLayer(e){return F(this,void 0,void 0,(function*(){return yield this.changeJimuQueryToJSAPILayerQuery(e).then((t=>F(this,void 0,void 0,(function*(){return yield this.layer.queryFeatureCount(t).then((t=>({queryParams:e,count:t})))}))))}))}doQueryCountByUrl(e){return F(this,void 0,void 0,(function*(){const t=this.changeJimuQueryToRestJSQuery(e);return delete t.resultRecordCount,delete t.resultOffset,t.returnCountOnly||(t.returnCountOnly=!0),yield this._q(t).then((t=>({queryParams:e,count:t.count})))}))}doQueryById(e){return F(this,void 0,void 0,(function*(){return yield this.doQuery((0,c.Immutable)({objectIds:[parseInt(e)],returnGeometry:!0}),(0,c.Immutable)({objectIds:[parseInt(e)],returnGeometry:!0})).then((e=>e.records[0]))}))}queryById(e){const t=Object.create(null,{queryById:{get:()=>super.queryById}});return F(this,void 0,void 0,(function*(){return yield t.queryById.call(this,e)}))}getConfigQueryParams(){const e=this.getDataViewConfig();return e?{where:c.dataSourceUtils.getArcGISSQL(e.where,this).sql,orderByFields:this.getOrderByArray(e.orderBy)}:null}mergeQueryParams(...e){const t=(e=e||[]).map((e=>null==e?void 0:e.where)).filter((e=>e)),r=t.length>1?t.map((e=>`(${e})`)).join(" and "):t[0],i=e.filter((e=>e)).reduce(((e,t)=>Object.assign(Object.assign({},e),t)),{});return Object.assign(Object.assign({},i),{where:r?`${r}`:""})}getCurrentQueryParams(e){const t=super.getCurrentQueryParams(e);return this.applyGDBVersionAndFix(t)}getRealQueryParams(e,t,r){const i=super.getRealQueryParams(e,t,r);return this.applyGDBVersionAndFix(i)}getRemoteQueryParams(){return this.getSchema().filter?{where:this.getSchema().filter}:null}applyGDBVersionAndFix(e){return this.getGDBVersion()&&(e.gdbVersion=this.getGDBVersion()),this.fixQueryParam((0,c.Immutable)(e)).asMutable({deep:!0})}fixQueryParam(e){let t=e;return e.outStatistics&&Object.keys(e).forEach((e=>{["groupByFieldsForStatistics","time","where","outStatistics","geometry","gdbVersion","returnDistinctValues"].includes(e)||(t=t.without(e))})),t}addRecordByLayer(e){return F(this,void 0,void 0,(function*(){const t=(yield c.dataSourceUtils.changeToJSAPIGraphic(e.feature)).clone();return yield this.layer.applyEdits({addFeatures:[t]}).then((e=>{var r,i;const a=null===(r=e.addFeatureResults[0])||void 0===r?void 0:r.objectId;if("number"!=typeof a||(null===(i=e.addFeatureResults[0])||void 0===i?void 0:i.error))return Promise.reject("Adding record failed.");const o=this.getIdField();return t.attributes[o]=a,new b(t,this)}))}))}addRecordByUrl(e){return F(this,void 0,void 0,(function*(){const t=c.dataSourceUtils.changeToRestAPIFeature(e.feature),r=Object.assign({},t),i={url:this.url,features:[r]};return yield c.requestUtils.requestWrapper(this.url,(e=>F(this,void 0,void 0,(function*(){return i.authentication=e,yield c.esri.restFeatureLayer.addFeatures(i).then((e=>{var t,i;const a=null===(t=e.addResults[0])||void 0===t?void 0:t.objectId;if("number"!=typeof a||!(null===(i=e.addResults[0])||void 0===i?void 0:i.success))return Promise.reject("Adding record failed.");const o=this.getIdField();return r.attributes[o]=a,new b(r,this)}))}))),1)}))}updateRecordsByLayer(e){return F(this,void 0,void 0,(function*(){const t=yield Promise.all(e.map((e=>F(this,void 0,void 0,(function*(){return yield c.dataSourceUtils.changeToJSAPIGraphic(e.feature).then((e=>e.clone()))})))));return this.layer.applyEdits({updateFeatures:t}).then((e=>e.updateFeatureResults.filter((e=>!e.error)).length>0))}))}updateRecordsByUrl(e){return F(this,void 0,void 0,(function*(){const t=e.map((e=>Object.assign({},c.dataSourceUtils.changeToRestAPIFeature(e.feature)))),r={url:this.url,features:t};return yield c.requestUtils.requestWrapper(this.url,(e=>F(this,void 0,void 0,(function*(){return r.authentication=e,yield c.esri.restFeatureLayer.updateFeatures(r).then((e=>e.updateResults.filter((e=>e.success)).length>0))}))),1)}))}deleteOneRecordByLayer(e){return F(this,void 0,void 0,(function*(){const t=(yield c.dataSourceUtils.changeToJSAPIGraphic(e.feature)).clone();return yield this.layer.applyEdits({deleteFeatures:[t]}).then((e=>e.deleteFeatureResults.filter((e=>!e.error)).length>0))}))}deleteOneRecordByUrl(e){return F(this,void 0,void 0,(function*(){const t=Object.assign({},c.dataSourceUtils.changeToRestAPIFeature(e.feature)),r=this.getIdField(),i=t.attributes[r],a={url:this.url,objectIds:[i]};return yield c.requestUtils.requestWrapper(this.url,(e=>F(this,void 0,void 0,(function*(){return a.authentication=e,yield c.esri.restFeatureLayer.deleteFeatures(a).then((e=>e.deleteResults.filter((e=>e.success)).length>0))}))),1)}))}fetchSchema(){return F(this,void 0,void 0,(function*(){return this.getDataSourceJson().isStatistic?yield Promise.resolve((0,c.Immutable)({})):this.layer?yield this.fetchSchemaWithLayer():yield this.fetchSchemaWithoutLayer()}))}createLayerByItemId(){return F(this,void 0,void 0,(function*(){return this.createFeatureLayerPromise?yield this.createFeatureLayerPromise:(this.layer?this.createFeatureLayerPromise=Promise.resolve(this.layer):this.itemId&&(this.createFeatureLayerPromise=(0,c.loadArcGISJSAPIModules)(["esri/layers/Layer","esri/portal/PortalItem"]).then((e=>F(this,void 0,void 0,(function*(){const t=e[0],r=e[1];return yield t.fromPortalItem({portalItem:new r({id:this.itemId,portal:{url:this.portalUrl}})})})))).then((e=>F(this,void 0,void 0,(function*(){return(null==e?void 0:e.type)===n.FeatureLayer?(this.layer=e,yield Promise.resolve(this.layer)):(null==e?void 0:e.type)===n.GroupLayer?yield e.loadAll().then((e=>F(this,void 0,void 0,(function*(){const t=e.layers.toArray().find((e=>`${e.layerId}`===this.layerId||c.dataSourceUtils.fixLayerId(e.title)===c.dataSourceUtils.fixLayerId(this.getMainDataSource().getLabel())));return(null==t?void 0:t.type)===n.FeatureLayer?(this.layer=t,Promise.resolve(this.layer)):Promise.reject("Feaure layer data source error: failed to create feature layer with specific layer id.")})))):void 0}))))),this.createFeatureLayerPromise)}))}fetchSchemaWithoutLayer(){return F(this,void 0,void 0,(function*(){const e=this.url?c.ServiceManager.getInstance().fetchServiceInfo(this.url):Promise.resolve(null);return yield e.then((e=>this.itemId?c.requestUtils.requestWrapper(this.getDataSourceJson().portalUrl,(t=>F(this,void 0,void 0,(function*(){return yield Promise.all([c.esri.restPortal.getItemData(this.itemId,{portal:c.portalUrlUtils.getPortalRestUrl(this.portalUrl),authentication:t}),c.esri.restPortal.getItem(this.itemId,{portal:c.portalUrlUtils.getPortalRestUrl(this.portalUrl),authentication:t})]).then((([t,r])=>{var i;const a=t&&t.layers&&t.layers[this.layerId],o=(null==e?void 0:e.definition)?this.getUpdatedLayerDefinition(a,e.definition):null==a?void 0:a.layerDefinition;return!this.parentDataSource&&o&&(o.name=(null==r?void 0:r.title)||o.name),{serviceDefinition:o,fieldInfos:a&&a.popupInfo&&a.popupInfo.fieldInfos,filter:(null===(i=null==a?void 0:a.layerDefinition)||void 0===i?void 0:i.definitionExpression)?`(${a.layerDefinition.definitionExpression})`:null,refreshInterval:60*(null==a?void 0:a.refreshInterval)}}))})))):{serviceDefinition:null==e?void 0:e.definition,fieldInfos:null,filter:null,refreshInterval:null})).then((({serviceDefinition:e,fieldInfos:t,filter:r,refreshInterval:i})=>{var a,o,s,n;const d={fields:{},idField:(null==e?void 0:e.idField)||(null===(o=null===(a=null==e?void 0:e.fields)||void 0===a?void 0:a.find((e=>"esriFieldTypeOID"===e.type)))||void 0===o?void 0:o.name)||"OBJECTID",filter:r,refreshInterval:i,label:(null===(s=this.layer)||void 0===s?void 0:s.title)||(null==e?void 0:e.name)};return this.layerDefinition=e,null===(n=null==e?void 0:e.fields)||void 0===n||n.forEach((e=>{const r=t&&t.find((t=>t.fieldName===e.name));d.fields[e.name]=c.dataSourceUtils.convertFieldToJimuField(e,r)})),(0,c.Immutable)(d)}))}))}fetchSchemaWithLayer(){return F(this,void 0,void 0,(function*(){return yield this.layer.load().then((()=>{var e,t;this.updateLayerDefinitionByLayer();const r={fields:{},idField:this.layer.objectIdField||(null===(t=null===(e=this.layer.fields)||void 0===e?void 0:e.find((e=>"oid"===e.type)))||void 0===t?void 0:t.name)||"OBJECTID",filter:this.layer.definitionExpression?`(${this.layer.definitionExpression})`:null,refreshInterval:60*this.layer.refreshInterval,label:this.layer.title};return this.layer.fields.forEach((e=>{const t=this.layer.popupTemplate&&this.layer.popupTemplate.fieldInfos&&this.layer.popupTemplate.fieldInfos.find((t=>t.fieldName===e.name));r.fields[e.name]=c.dataSourceUtils.convertFieldToJimuField(e.toJSON(),null==t?void 0:t.toJSON())})),(0,c.Immutable)(r)}))}))}updateLayerDefinitionByLayer(){let e=this.layer.sourceJSON;const t=this.layer.renderer;if(t&&t.toJSON()){const r=t.toJSON();if("uniqueValue"===r.type){let t=this.layer.sourceJSON.types;r.field1!==this.layer.sourceJSON.typeIdField&&(t=[],r.uniqueValueInfos.forEach((e=>{t.push({id:e.value,name:e.label,domain:{}})}))),e=Object.assign({name:this.layer.title},e,{drawingInfo:{renderer:r},typeIdField:r.field1,types:t})}}this.layerDefinition=e}getLayerDefinition(){return c.dataSourceUtils.getLayerDefinition(this)}getFieldCodedValueList(e,t){let r="";const i=this.getSchema().fields;return Object.keys(i).some((t=>t===e&&(r=i[t].name,!0))),c.dataSourceUtils.getCodedValueListForCodedValueOrSubtypeField(this.getLayerDefinition(),r,t)}getGDBVersion(){return this.getInfo().gdbVersion}changeGDBVersion(e){(0,c.getAppStore)().dispatch(c.appActions.changeDataSourceGDBVersion(this.id,e)),this.layer&&(this.layer.gdbVersion=e)}getUpdatedLayerDefinition(e,t){let r=t;if(e&&e.layerDefinition){let i;const a=e.layerDefinition.drawingInfo;if(a){if(a.renderer&&"uniqueValue"===a.renderer.type){let r=t.types;a.renderer.field1!==t.typeIdField&&(r=[],a.renderer.uniqueValueInfos.forEach((e=>{r.push({id:e.value,name:e.label,domain:{}})}))),i={defaultVisibility:e.layerDefinition.defaultVisibility,drawingInfo:e.layerDefinition.drawingInfo,typeIdField:a.renderer.field1,types:r}}}else e.layerDefinition.defaultVisibility!==t.defaultVisibility&&(i={defaultVisibility:e.layerDefinition.defaultVisibility});r=Object.assign({},r,i)}return r}getOrderByArray(e){var t;return null!==(t=null==e?void 0:e.map((e=>e.jimuFieldName+" "+e.order)).asMutable())&&void 0!==t?t:[]}changeJimuQueryToRestJSQuery(e){var t;if(!e)return null;const r=this.fixQueryParam(e).asMutable({deep:!0});if("number"==typeof r.pageSize){const e=null!==(t=r.page)&&void 0!==t?t:1;r.resultOffset=(e-1)*r.pageSize,r.resultRecordCount=r.pageSize,null!==this.getMaxRecordCount()&&(1===e?r.resultRecordCount=Math.min(this.getMaxRecordCount(),r.pageSize):e*r.pageSize>this.getMaxRecordCount()&&(r.resultRecordCount=this.getMaxRecordCount()-(e-1)*r.pageSize)),delete r.page,delete r.pageSize}return Array.isArray(r.orderByFields)&&(r.orderByFields=r.orderByFields.join(",")),Array.isArray(r.groupByFieldsForStatistics)&&(r.groupByFieldsForStatistics=r.groupByFieldsForStatistics.join(",")),r}changeJimuQueryToJSAPILayerQuery(e){return F(this,void 0,void 0,(function*(){return yield c.dataSourceUtils.changeJimuFeatureLayerQueryToJSAPILayerQuery(this,e)}))}doQueryByUrl(e){var t;return F(this,void 0,void 0,(function*(){const r=this.changeJimuQueryToRestJSQuery(e);if(r.returnCountOnly)return console.error("To query count, please use queryCount."),yield Promise.reject("To query count, please use queryCount.");if(r.outFields&&"*"!==r.outFields&&"*"!==r.outFields[0]){const e=null===(t=this.getLayerDefinition())||void 0===t?void 0:t.typeIdField;e&&!r.outFields.includes(e)&&r.outFields.push(e)}return yield this._q(r).then((t=>{const r=Object.keys(this.getSchema().fields).filter((e=>t.fields&&t.fields.find((t=>t.name===this.getSchema().fields[e].name))));return{queryParams:e,fields:r,records:t.features.map((e=>new b(e,this)))}}))}))}doQueryByLayer(e){return F(this,void 0,void 0,(function*(){return yield this.changeJimuQueryToJSAPILayerQuery(e).then((t=>F(this,void 0,void 0,(function*(){var r;const i=t;if(i.outFields&&"*"!==i.outFields[0]){const e=null===(r=this.getLayerDefinition())||void 0===r?void 0:r.typeIdField;e&&!i.outFields.includes(e)&&i.outFields.push(e)}return yield this.layer.queryFeatures(i).then((t=>{const r=t.features.map((e=>new b(e,this))),i=Object.keys(this.getSchema().fields).filter((e=>t.fields&&t.fields.find((t=>t.name===this.getSchema().fields[e].name))));return{queryParams:e,records:r,fields:i}}))}))))}))}_q(e){return F(this,void 0,void 0,(function*(){const t=Object.assign({url:this.url},e);return yield c.requestUtils.requestWrapper(this.url,(e=>F(this,void 0,void 0,(function*(){return t.authentication=e,yield c.esri.restFeatureLayer.queryFeatures(t)}))),1)}))}allowToExportData(){var e,t,r;return F(this,void 0,void 0,(function*(){if(this.isDataView||this.isLocal)return yield this.getMainDataSource().allowToExportData();if(this.getDataSourceJson().isOutputFromWidget&&1===(null===(e=this.getDataSourceJson().originDataSources)||void 0===e?void 0:e.length)){const e=null===(t=this.getDataSourceJson().originDataSources[0])||void 0===t?void 0:t.dataSourceId,r=e&&this.dataSourceManager.getDataSource(e);return r?yield r.allowToExportData():(console.error("Origin data source is not created, allow to export data by default. Output data source id is ",this.id),yield Promise.resolve(!0))}return this.getDataSourceJson().disableExport?yield Promise.resolve(!1):yield null!==(r=this.allowExportRemoteCheckPromise)&&void 0!==r?r:this.allowToExportDataInRemote()}))}allowToExportDataInRemote(){return F(this,void 0,void 0,(function*(){return this.allowExportRemoteCheckPromise=c.dataSourceUtils.isDataSourceSubscriberOrPremium(this.getDataSourceJson()).then((e=>!e&&this.allowToExportDataInItem())),this.allowExportRemoteCheckPromise}))}allowToExportDataInItem(){return F(this,void 0,void 0,(function*(){try{if(!this.itemId)return!0;const e=(0,c.getAppStore)().getState().portalUrl,t=yield c.esri.restPortal.getItem(this.itemId,{portal:c.portalUrlUtils.getPortalRestUrl(e),authentication:c.SessionManager.getInstance().getMainSession()}),r=(0,c.getAppStore)().getState().user,i="org_admin"===(null==r?void 0:r.role);return r&&"self"===(null==t?void 0:t.contentOrigin)?!!i||(!(!r||(null==t?void 0:t.owner)!==r.username)||(yield this.getWhetherAllowToExportInItemSetting())):yield this.getWhetherAllowToExportInItemSetting()}catch(e){return console.log(`Failed to get whether data source ${this.id} allows to export data, `,e),!0}}))}getWhetherAllowToExportInItemSetting(){var e;return F(this,void 0,void 0,(function*(){if(this.url){const t=yield c.requestUtils.requestWrapper(this.url,(e=>F(this,void 0,void 0,(function*(){return yield c.esri.restRequest.request(this.url,{authentication:e,httpMethod:"GET"})}))),1);return!!(null===(e=null==t?void 0:t.capabilities)||void 0===e?void 0:e.includes("Extract"))}return!0}))}getPopupInfo(){return F(this,void 0,void 0,(function*(){return yield c.dataSourceUtils.getPopupInfo(this)}))}supportSymbol(){return c.dataSourceUtils.supportSymbol(this)}supportAttachment(){return c.dataSourceUtils.supportAttachment(this)}createJSAPILayerByDataSource(){return F(this,void 0,void 0,(function*(){return yield c.dataSourceUtils.createJSAPILayerByDataSource(this)}))}get layer(){var e,r,i,a;if(this.getDataSourceJson().isOutputFromWidget&&!this.getDataSourceJson().isDataInDataSourceInstance&&1===(null===(e=this.getDataSourceJson().originDataSources)||void 0===e?void 0:e.length)){const e=null===(r=this.getDataSourceJson().originDataSources[0])||void 0===r?void 0:r.dataSourceId,a=e&&this.dataSourceManager.getDataSource(e);if((null==a?void 0:a.type)===t.FeatureLayer&&(null==a?void 0:a.layer))return a.layer;if((null==a?void 0:a.type)===t.SceneLayer&&(null===(i=null==a?void 0:a.getAssociatedDataSource())||void 0===i?void 0:i.layer))return a.getAssociatedDataSource().layer}return!this._layer&&(null===(a=this.belongToDataSource)||void 0===a?void 0:a.layer)?this.belongToDataSource.layer:this._layer}set layer(e){this._layer=e}}var J=function(e,t,r,i){return new(r||(r=Promise))((function(a,o){function s(e){try{d(i.next(e))}catch(e){o(e)}}function n(e){try{d(i.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,n)}d((i=i.apply(e,t||[])).next())}))};class O extends y{constructor(){super(...arguments),this.type=t.FeatureService}fetchServiceDefinition(){return J(this,void 0,void 0,(function*(){return yield this.fetchServiceDefinitionByUrl()}))}createChildDataSources(){return J(this,void 0,void 0,(function*(){return yield this.createChildDataSourcesByUrl()}))}}var T=function(e,t,r,i){return new(r||(r=Promise))((function(a,o){function s(e){try{d(i.next(e))}catch(e){o(e)}}function n(e){try{d(i.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,n)}d((i=i.apply(e,t||[])).next())}))};class U extends y{constructor(){super(...arguments),this.type=t.GroupLayer}fetchServiceDefinition(){return T(this,void 0,void 0,(function*(){return this.layer?(this.updateServiceDefinitionByLayer(),yield Promise.resolve(this.getServiceDefinition())):this.url?yield this.fetchServiceDefinitionByUrl():this.getDataSourceJson().itemId?yield this.fetchServiceDefnitionByItem():yield Promise.reject("Failed to fetch service definition, need url or layer or item id.")}))}createChildDataSources(){return T(this,void 0,void 0,(function*(){return this.layer?yield this.createChildDataSourcesByLayer():this.url?yield this.createChildDataSourcesByUrl():this.getDataSourceJson().itemId?yield this.createChildDataSourcesByItem():yield Promise.reject("Failed to create child data source, need url or layer or item id.")}))}createChildDataSourcesByLayer(){return T(this,void 0,void 0,(function*(){if(!this.childDataSourcesPromise){let e;if(this.layer.type===n.GroupLayer){const t=this.layer;e=t.loadAll().then((()=>T(this,void 0,void 0,(function*(){var e;const r=(null===(e=t.layers)||void 0===e?void 0:e.toArray())||[];return yield Promise.allSettled(r.reverse().filter((e=>c.dataSourceUtils.isJSAPILayerTypeSupported(e))).map((e=>T(this,void 0,void 0,(function*(){var t,r,i;if(e.type===n.SceneLayer){if(e.associatedLayer)return yield Promise.resolve(e);{const a=e;return yield c.dataSourceUtils.fetchAssociatedFeatureLayerUrl(c.dataSourceUtils.getUrlByLayer(a),`${a.layerId}`,null===(t=a.portalItem)||void 0===t?void 0:t.id,null===(i=null===(r=a.portalItem)||void 0===r?void 0:r.portal)||void 0===i?void 0:i.url).then((e=>e?a:Promise.reject("Scene layer does not have associated layer")))}}return Promise.resolve(e)}))))).then((e=>e.filter((e=>"fulfilled"===e.status)).map((e=>e.value)))).then((e=>e.map(((e,t)=>this.getLayerDefinitionFromLayer(e,t))))).then((e=>e.filter((e=>!!e)).filter((e=>c.dataSourceUtils.isLayerDefinitionTypeSupported(e.def)||c.dataSourceUtils.isJSAPILayerTypeSupported(e.layer)))))}))))}else{const t=this.layer;e=t.load().then((()=>T(this,void 0,void 0,(function*(){var e;const r=((null===(e=t.sublayers)||void 0===e?void 0:e.toArray())||[]).reverse().map(((e,t)=>this.getLayerDefinitionFromLayer(e,t))).filter((e=>!!e));let i=[];return r.forEach((e=>{c.dataSourceUtils.isLayerDefinitionTypeSupported(e.def)&&(i=i.concat(e))})),i}))))}this.childDataSourcesPromise=e.then((e=>T(this,void 0,void 0,(function*(){const t=[];let r=[];return e.reverse().forEach((e=>{const i=c.dataSourceUtils.getDataSourceSourceUrl(e.url),a=this.getDsJsons(i,e.layer,e.def,r);r=r.concat(a),a.forEach((r=>{const i={id:r.id,dataSourceJson:r,parentDataSource:this,jimuChildId:this.getJimuChildIdFromChildDsId(r.id),layer:e.layer,order:e.order};t.push(this.dataSourceManager.createDataSource(i))}))})),Promise.allSettled(t).then((e=>e.filter((e=>"fulfilled"===e.status)).map((e=>e.value))))}))))}return this.childDataSourcesPromise}))}createChildDataSourcesByItem(){return T(this,void 0,void 0,(function*(){if(!this.childDataSourcesPromise){const e=c.requestUtils.requestWrapper(this.getDataSourceJson().portalUrl,(e=>T(this,void 0,void 0,(function*(){return yield c.esri.restPortal.getItemData(this.getDataSourceJson().itemId,{portal:c.portalUrlUtils.getPortalRestUrl(this.getDataSourceJson().portalUrl),authentication:e}).then((e=>{var t;return((null===(t=null==e?void 0:e.layers)||void 0===t?void 0:t.map((e=>e.layerDefinition)))||[]).filter((e=>e.type===r.FeatureLayer))}))}))));this.childDataSourcesPromise=e.then((e=>T(this,void 0,void 0,(function*(){const t=[];let r=[];return e.forEach((e=>{const i=this.getDsJsonsFromSingleLayerDefinition(null,e,r);r=r.concat(i),i.forEach((r=>{const i={id:r.id,dataSourceJson:r,parentDataSource:this,jimuChildId:this.getJimuChildIdFromChildDsId(r.id),order:e.id};t.push(this.dataSourceManager.createDataSource(i))}))})),Promise.allSettled(t).then((e=>e.filter((e=>"fulfilled"===e.status)).map((e=>e.value))))}))))}return this.childDataSourcesPromise}))}updateServiceDefinitionByLayer(){!this.serviceDefinition&&this.layer&&("esri.layers.GroupLayer"===this.layer.declaredClass?this.serviceDefinition={name:this.layer.title}:"esri.layers.support.Sublayer"===this.layer.declaredClass&&(this.serviceDefinition=this.layer.sourceJSON))}fetchServiceDefnitionByItem(){return T(this,void 0,void 0,(function*(){return this.getServiceDefinition()?yield Promise.resolve(this.getServiceDefinition()):yield c.requestUtils.requestWrapper(this.getDataSourceJson().portalUrl,(e=>T(this,void 0,void 0,(function*(){return yield c.esri.restPortal.getItem(this.getDataSourceJson().itemId,{portal:c.portalUrlUtils.getPortalRestUrl(this.getDataSourceJson().portalUrl),authentication:e}).then((e=>(this.serviceDefinition={name:e.title},this.serviceDefinition)))}))))}))}getLayerDefinitionFromLayer(e,t){var r;const i=c.dataSourceUtils.getUrlByLayer(e),a=c.dataSourceUtils.isSupportedService(i),o=c.dataSourceUtils.isJSAPILayerTypeSupported(e);return a||o?e.sourceJSON?i||(null===(r=e.portalItem)||void 0===r?void 0:r.id)?{layer:e,url:i,def:e.sourceJSON,order:t}:null:e.type===n.SceneLayer?{layer:e,url:i,def:null,order:t}:null:null}getDsJsons(e,t,r,i){return t&&"esri.layers.support.Sublayer"!==t.declaredClass?this.getDsJsonsFromSingleLayer(e,t,r,i):this.getDsJsonsFromSingleLayerDefinition(e,r,i)}getDsJsonsFromSingleLayer(e,r,i,a){if(!r)return[];const o=[];let s;const d=this.getJimuChildIdByJSAPILayerOrServiceDefinition(r,null,e,a),u=c.dataSourceUtils._getFixedLayerIdByLayerDefinition(i)||c.dataSourceUtils.getServiceLabelFromUrl(e);return d.forEach((i=>{var a,d,l;const h=this.getDataSourceJson().schema?null===(a=this.getDataSourceJson().schema.childSchemas)||void 0===a?void 0:a[i]:null,S=this.getChildDataSourceId(i),g=(null===(d=this.getDataSourceJson().childDataSourceJsons)||void 0===d?void 0:d[i])||(null===(l=this.getDataSourceJson().childDataSourceJsons)||void 0===l?void 0:l[u]);r.type===n.GroupLayer?s=(0,c.Immutable)({id:S,type:t.GroupLayer}):r.type===n.FeatureLayer?s=(0,c.Immutable)({id:S,type:t.FeatureLayer,layerId:`${r.layerId}`}):r.type===n.SceneLayer?s=(0,c.Immutable)({id:S,type:t.SceneLayer,layerId:`${r.layerId}`}):r.type!==n.MapImageLayer&&r.type!==n.TileLayer||(s=(0,c.Immutable)({id:S,type:t.MapService})),s&&(this.getDataSourceJson().portalUrl&&(s=s.set("portalUrl",this.getDataSourceJson().portalUrl)),this.getDataSourceJson().itemId&&(s=s.set("itemId",this.getDataSourceJson().itemId)),h&&(s=s.set("schema",h)),e&&(s=s.set("url",e)),s=g?s.merge(g.without("id").asMutable({deep:!0})):s,o.push(s.set("jimuChildId",i)))})),o}}var Q=function(e,t,r,i){return new(r||(r=Promise))((function(a,o){function s(e){try{d(i.next(e))}catch(e){o(e)}}function n(e){try{d(i.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,n)}d((i=i.apply(e,t||[])).next())}))};class M extends y{constructor(){super(...arguments),this.type=t.MapService}fetchServiceDefinition(){return Q(this,void 0,void 0,(function*(){return this.layer?(this.updateServiceDefinitionByLayer(),yield Promise.resolve(this.getServiceDefinition())):this.url?yield this.fetchServiceDefinitionByUrl():yield Promise.reject("Failed to fetch service definition, need url or layer.")}))}createChildDataSources(){return Q(this,void 0,void 0,(function*(){return this.layer?yield this.createChildDataSourcesByLayer():yield this.createChildDataSourcesByUrl()}))}createChildDataSourcesByLayer(){return Q(this,void 0,void 0,(function*(){if(!this.childDataSourcesPromise){const e=(this.layer.loadAll?this.layer.loadAll():this.layer.load()).then((()=>Q(this,void 0,void 0,(function*(){var e;const t=((null===(e=this.layer.sublayers)||void 0===e?void 0:e.toArray())||[]).reverse().map(((e,t)=>this.getLayerDefinitionFromSubLayer(e,t))).filter((e=>!!e));let r=[];return t.forEach((e=>{c.dataSourceUtils.isLayerDefinitionTypeSupported(e.def)&&(r=r.concat(e))})),r}))));this.childDataSourcesPromise=e.then((e=>Q(this,void 0,void 0,(function*(){const t=[];let r=[];return e.forEach((e=>{const i=this.getDsJsonsFromSingleLayerDefinition(c.dataSourceUtils.getDataSourceSourceUrl(e.url),e.def,r);r=r.concat(i),i.forEach((r=>{const i={id:r.id,dataSourceJson:r,parentDataSource:this,jimuChildId:this.getJimuChildIdFromChildDsId(r.id),layer:e.layer,order:e.order};t.push(this.dataSourceManager.createDataSource(i))}))})),Promise.allSettled(t).then((e=>e.filter((e=>"fulfilled"===e.status)).map((e=>e.value))))}))))}return this.childDataSourcesPromise}))}updateServiceDefinitionByLayer(){!this.serviceDefinition&&this.layer&&(this.serviceDefinition=this.layer.sourceJSON)}getLayerDefinitionFromSubLayer(e,t){const r=c.dataSourceUtils.getUrlByLayer(e);return r&&c.dataSourceUtils.isSupportedService(r)?{layer:e,url:r,def:e.sourceJSON,order:t}:null}}var B=function(e,t,r,i){return new(r||(r=Promise))((function(a,o){function s(e){try{d(i.next(e))}catch(e){o(e)}}function n(e){try{d(i.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,n)}d((i=i.apply(e,t||[])).next())}))};class x extends h{constructor(){super(...arguments),this.type=t.SimpleLocal}updateRecoreds(e){this.records=e,this.addVersion()}addRecord(e){return B(this,void 0,void 0,(function*(){return e.getId()||e.setId((0,c.uuidv1)()),this.records.push(e),this.addVersion(),yield Promise.resolve(e)}))}updateRecord(e){return B(this,void 0,void 0,(function*(){const t=this.records.findIndex((t=>t.getId()===e.getId()));return this.records.splice(t,1,e),this.addVersion(),Promise.resolve(!0)}))}deleteRecord(e){return B(this,void 0,void 0,(function*(){return this.records.splice(e,1),this.addVersion(),yield Promise.resolve(!0)}))}}var j=function(e,t,r,i){return new(r||(r=Promise))((function(a,o){function s(e){try{d(i.next(e))}catch(e){o(e)}}function n(e){try{d(i.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,n)}d((i=i.apply(e,t||[])).next())}))};class N extends y{constructor(){super(...arguments),this.type=t.SceneService}fetchServiceDefinition(){return j(this,void 0,void 0,(function*(){return yield this.fetchServiceDefinitionByUrl()}))}createChildDataSources(){return j(this,void 0,void 0,(function*(){return yield this.createChildDataSourcesByUrl()}))}}var _=function(e,t,r,i){return new(r||(r=Promise))((function(a,o){function s(e){try{d(i.next(e))}catch(e){o(e)}}function n(e){try{d(i.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,n)}d((i=i.apply(e,t||[])).next())}))};class q extends R{constructor(e){var r,i;super(e),this.type=t.SceneLayer;const a=this.getDataSourceJson();if(this.portalUrl=a.portalUrl,this.itemId=a.itemId,this.layerId=a.layerId,e.layer&&(this.layer=e.layer),e.belongToDataSource&&e.belongToDataSource.layer&&(this.layer=e.belongToDataSource.layer),this.isLocal){const t=null===(r=e.belongToDataSource)||void 0===r?void 0:r.getAssociatedDataSource();t&&c.DataSourceManager.getInstance().createLocalDataSource(t,this.localId)}else if(this.isDataView){const t=null===(i=e.belongToDataSource)||void 0===i?void 0:i.getAssociatedDataSource();t&&c.DataSourceManager.getInstance().createDataView(t,this.dataViewId)}this.getAssociatedDataSource()&&((0,c.observeStore)(this.onInfoChange.bind(this),["dataSourcesInfo",this.getAssociatedDataSource().id]),this.getAssociatedDataSource().setAssociatedDataSource(this))}ready(){const e=Object.create(null,{ready:{get:()=>super.ready}});return _(this,void 0,void 0,(function*(){return yield Promise.all([this.fetchLayerDefinition(),this.createAssociatedDataSource()]).then((()=>_(this,void 0,void 0,(function*(){return yield e.ready.call(this)})))).then((()=>{this.getAssociatedDataSource()&&(0,c.observeStore)(this.onInfoChange.bind(this),["dataSourcesInfo",this.getAssociatedDataSource().id])}))}))}onInfoChange(){this.getAssociatedDataSource()&&!c.utils.isDeepEqual(this.getInfo().without("instanceStatus"),this.getAssociatedDataSource().getInfo().without("instanceStatus"))&&(0,c.getAppStore)().dispatch(c.appActions.updateDataSourceInfo(this.id,this.getAssociatedDataSource().getInfo().without("instanceStatus").set("instanceStatus",this.getInfo().instanceStatus)))}createAssociatedDataSource(){return _(this,void 0,void 0,(function*(){return this.associatedDataSource?yield Promise.resolve(this.associatedDataSource):this.layer?yield this._createAssociatedDataSourceWithLayer().then((e=>e||this._createAssociatedDataSourceWithUrl())):this._createAssociatedDataSourceWithUrl()}))}_createAssociatedDataSourceWithLayer(){return _(this,void 0,void 0,(function*(){const e=this._getNewAssociatedDataSourceId();return yield this.layer.load().then((()=>_(this,void 0,void 0,(function*(){if(!this.layer.associatedLayer)return null;let r=(0,c.Immutable)({id:e,type:t.FeatureLayer,url:c.dataSourceUtils.getUrlByLayer(this.layer.associatedLayer)});r=this._mergeAssociatedDataSourceJson(r);const i={id:e,dataSourceJson:r,layer:this.layer.associatedLayer,associatedDataSource:this};return yield this.dataSourceManager.createDataSource(i)})))).then((e=>(this.associatedDataSource=e,this.associatedDataSource)))}))}_createAssociatedDataSourceWithUrl(){return _(this,void 0,void 0,(function*(){const e=this._getNewAssociatedDataSourceId();return yield c.dataSourceUtils.fetchAssociatedFeatureLayerDefinition(this.url,this.layerId,this.itemId,this.portalUrl).then((t=>{if(!t)return Promise.reject("Can not find associated feature layer");let r=c.dataSourceUtils.getSingleDsJsonFromLayerDefinition(e,t.url,t.def);return r=this._mergeAssociatedDataSourceJson(r),r})).then((e=>_(this,void 0,void 0,(function*(){const t={id:e.id,dataSourceJson:e,associatedDataSource:this};return yield this.dataSourceManager.createDataSource(t)})))).then((e=>(this.associatedDataSource=e,this.associatedDataSource)))}))}_getNewAssociatedDataSourceId(){return`${this.getDataSourceJson().id}-associated_data_source`}fetchLayerDefinition(){return _(this,void 0,void 0,(function*(){const e=this.url;return e?this.getLayerDefinition()?yield Promise.resolve(this.getLayerDefinition()):yield c.ServiceManager.getInstance().fetchServiceInfo(e).then((e=>e.definition)).then((e=>e?(this.layerDefinition=e,e):null)):yield Promise.resolve(null)}))}getLayerDefinition(){return c.dataSourceUtils.getLayerDefinition(this)}fetchSchema(){return _(this,void 0,void 0,(function*(){const e=yield c.dataSourceUtils.getOriginDataLabel(this.getLayerDefinition(),this.layer,this),t=(0,c.Immutable)({label:e}),r=yield this.getAssociatedDataSource()?this.getAssociatedDataSource().fetchSchema():Promise.reject({});return r?r.merge(t):t}))}getSchema(){var e;const t=null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getSchema(),r=super.getSchema();return t?t.merge(r):r}setSchema(e){var t;null===(t=this.getAssociatedDataSource())||void 0===t||t.setSchema(e)}setDataSourceJson(e){super.setDataSourceJson(e);const t=this.getAssociatedDataSource();if(t){const e=this._mergeAssociatedDataSourceJson(t.getDataSourceJson());t.setDataSourceJson(e)}}getFetchedSchema(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getFetchedSchema()}setFetchedSchema(e){var t;null===(t=this.getAssociatedDataSource())||void 0===t||t.setFetchedSchema(e)}getReversedConfigSchema(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getReversedConfigSchema()}getSelectedFields(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getSelectedFields()}setSelectedFields(e){var t;null===(t=this.getAssociatedDataSource())||void 0===t||t.setSelectedFields(e)}getIdField(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getIdField()}setJsonData(e){var t;null===(t=this.getAssociatedDataSource())||void 0===t||t.setJsonData(e)}queryById(e){var t,r;return _(this,void 0,void 0,(function*(){return yield null!==(r=null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.queryById(e))&&void 0!==r?r:Promise.reject(Error("No Associated DataSource."))}))}addRecord(e){var t;return _(this,void 0,void 0,(function*(){return yield null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.addRecord(e)}))}updateRecord(e){var t;return _(this,void 0,void 0,(function*(){return yield null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.updateRecord(e)}))}updateRecords(e){var t;return _(this,void 0,void 0,(function*(){return yield null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.updateRecords(e)}))}deleteRecord(e){var t;return _(this,void 0,void 0,(function*(){return yield null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.deleteRecord(e)}))}deleteRecordById(e){var t;return _(this,void 0,void 0,(function*(){return yield null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.deleteRecordById(e)}))}doQuery(e,t){var r,i;return _(this,void 0,void 0,(function*(){return yield null!==(i=null===(r=this.getAssociatedDataSource())||void 0===r?void 0:r.doQuery(e,t))&&void 0!==i?i:Promise.reject(Error("No Associated DataSource."))}))}doQueryById(e){var t,r;return _(this,void 0,void 0,(function*(){return yield null!==(r=null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.doQueryById(e))&&void 0!==r?r:Promise.reject(Error("No Associated DataSource."))}))}doQueryCount(e){var t,r;return _(this,void 0,void 0,(function*(){return yield null!==(r=null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.doQueryCount(e))&&void 0!==r?r:Promise.reject(Error("No Associated DataSource."))}))}getConfigQueryParams(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getConfigQueryParams()}getRemoteQueryParams(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getRemoteQueryParams()}getCurrentQueryParams(e){var t;return e&&this.fixExcludeQuery(e),null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.getCurrentQueryParams(e)}getRuntimeQueryParamsgetRuntimeQueryParams(e){var t;return null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.getRuntimeQueryParams(e)}getCurrentQueryId(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getCurrentQueryId()}mergeQueryParams(...e){var t;return null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.mergeQueryParams(...e)}getFieldCodedValueList(e,t){var r;return null===(r=this.getAssociatedDataSource())||void 0===r?void 0:r.getFieldCodedValueList(e,t)}getRealQueryParams(e,t,r){var i;return r&&this.fixQueryOptions(r),null===(i=this.getAssociatedDataSource())||void 0===i?void 0:i.getRealQueryParams(e,t,r)}updateQueryParams(e,t){var r;return null===(r=this.getAssociatedDataSource())||void 0===r?void 0:r.updateQueryParams(e,t)}getGDBVersion(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getGDBVersion()}getQueryPageSize(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getQueryPageSize()}getMaxRecordCount(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getMaxRecordCount()}getRecordsByPage(e,t){var r;return null===(r=this.getAssociatedDataSource())||void 0===r?void 0:r.getRecordsByPage(e,t)}getPagesData(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getPagesData()}setPagesData(e){var t;null===(t=this.getAssociatedDataSource())||void 0===t||t.setPagesData(e)}getRealQueryPages(e,t){var r;return null===(r=this.getAssociatedDataSource())||void 0===r?void 0:r.getRealQueryPages(e,t)}load(e,t={}){var r,i;return _(this,void 0,void 0,(function*(){return t&&this.fixQueryOptions(t),null!==(i=yield null===(r=this.getAssociatedDataSource())||void 0===r?void 0:r.load(e,t))&&void 0!==i?i:Promise.reject(Error("No Associated DataSource."))}))}loadCount(e,t={}){var r,i;return _(this,void 0,void 0,(function*(){return t&&this.fixQueryOptions(t),null!==(i=yield null===(r=this.getAssociatedDataSource())||void 0===r?void 0:r.loadCount(e,t))&&void 0!==i?i:Promise.reject(Error("No Associated DataSource."))}))}query(e,t){var r,i;return _(this,void 0,void 0,(function*(){return t&&this.fixQueryOptions(t),null!==(i=yield null===(r=this.getAssociatedDataSource())||void 0===r?void 0:r.query(e,t))&&void 0!==i?i:Promise.reject(Error("No Associated DataSource."))}))}queryCount(e,t){var r,i;return _(this,void 0,void 0,(function*(){return t&&this.fixQueryOptions(t),null!==(i=yield null===(r=this.getAssociatedDataSource())||void 0===r?void 0:r.queryCount(e,t))&&void 0!==i?i:Promise.reject(Error("No Associated DataSource."))}))}loadById(e,t){var r,i;return _(this,void 0,void 0,(function*(){return null!==(i=yield null===(r=this.getAssociatedDataSource())||void 0===r?void 0:r.loadById(e,t))&&void 0!==i?i:Promise.reject(Error("No Associated DataSource."))}))}changeGDBVersion(e){var t;null===(t=this.getAssociatedDataSource())||void 0===t||t.changeGDBVersion(e)}getAssociatedDataSource(){if(!this.isDataView&&!this.isLocal)return this.associatedDataSource;const e=this._getRealAssociatedDataSourceId();return c.DataSourceManager.getInstance().getDataSource(e)}getAssociatedDataSourceById(e){return this.dataSourceManager.getDataSource(e).getAssociatedDataSource()}fixQueryOptions(e){e&&e.excludeQuery&&this.fixExcludeQuery(e.excludeQuery)}fixExcludeQuery(e){(null==e?void 0:e.dataSourceId)&&this.getAssociatedDataSourceById(e.dataSourceId)&&(e.dataSourceId=this.getAssociatedDataSourceById(e.dataSourceId).id)}_getRealAssociatedDataSourceId(){var e;let t;const r=null===(e=this.belongToDataSource)||void 0===e?void 0:e.getAssociatedDataSource();return t=this.isLocal?c.DataSourceManager.getInstance().getLocalDataSourceId(null==r?void 0:r.id,this.localId):this.isDataView?c.DataSourceManager.getInstance().getDataViewDataSourceId(null==r?void 0:r.id,this.dataViewId):this.associatedDataSource.id,t}clearRecords(){var e;null===(e=this.getAssociatedDataSource())||void 0===e||e.clearRecords()}setRecords(e){var t;null===(t=this.getAssociatedDataSource())||void 0===t||t.setRecords(e)}getRecords(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getRecords()}getSelectedRecords(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.getSelectedRecords()}nextRecord(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.nextRecord()}prevRecord(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.prevRecord()}getRecord(e){var t;return null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.getRecord(e)}getRecordById(e){var t;return null===(t=this.getAssociatedDataSource())||void 0===t?void 0:t.getRecordById(e)}clearRecordsNotAddVersion(){var e;super.clearRecordsNotAddVersion(),null===(e=this.getAssociatedDataSource())||void 0===e||e.clearRecordsNotAddVersion()}clearSelection(){var e;super.clearSelection(),null===(e=this.getAssociatedDataSource())||void 0===e||e.clearSelection()}addVersion(){var e;null===(e=this.getAssociatedDataSource())||void 0===e||e.addVersion()}selectRecord(e){var t;super.selectRecord(e),null===(t=this.getAssociatedDataSource())||void 0===t||t.selectRecord(e)}selectRecords(e){var t;super.selectRecords(e),null===(t=this.getAssociatedDataSource())||void 0===t||t.selectRecords(e)}selectRecordById(e,t){var r;super.selectRecordById(e,t),null===(r=this.getAssociatedDataSource())||void 0===r||r.selectRecordById(e,t)}selectRecordsByIds(e,t){var r;super.selectRecordsByIds(e,t),null===(r=this.getAssociatedDataSource())||void 0===r||r.selectRecordsByIds(e,t)}destroy(){const e=this.getAssociatedDataSource();e&&this.dataSourceManager.destroyDataSource(e.id)}supportSymbol(){return c.dataSourceUtils.supportSymbol(this)}supportAttachment(){return c.dataSourceUtils.supportAttachment(this)}createJSAPILayerByDataSource(){return _(this,void 0,void 0,(function*(){return yield c.dataSourceUtils.createJSAPILayerByDataSource(this)}))}_mergeAssociatedDataSourceJson(e){return null==e?void 0:e.set("query",this.getDataSourceJson().query).set("dataViews",this.getDataSourceJson().dataViews).set("schema",this.getDataSourceJson().schema)}get count(){var e;return null===(e=this.getAssociatedDataSource())||void 0===e?void 0:e.count}set count(e){this.getAssociatedDataSource()&&(this.getAssociatedDataSource().count=e)}getPopupInfo(){return _(this,void 0,void 0,(function*(){return yield c.dataSourceUtils.getPopupInfo(this)}))}allowToExportData(){return _(this,void 0,void 0,(function*(){const e=!this.getDataSourceJson().disableExport;return yield Promise.resolve(e)}))}}class W{createDataSource(e){var r;const i=null!==(r=e.dataSourceJson)&&void 0!==r?r:e.belongToDataSource.getMainDataSource().getDataSourceJson(),a=e.dataViewId&&i.dataViews&&i.dataViews[e.dataViewId]&&i.dataViews[e.dataViewId].type||i.type;return a===t.CSV?new V(e):a===t.FeatureLayer?new E(e):a===t.FeatureService?new O(e):a===t.GroupLayer?new U(e):a===t.MapService?new M(e):a===t.SceneService?new N(e):a===t.SceneLayer?new q(e):a===t.SimpleLocal?new x(e):void console.error("Unimplemented data source type.",i.type)}}const G=W})(),a})())}}}));